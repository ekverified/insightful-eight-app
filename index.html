<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Insightful Eight Ltd | v1.0.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { 500: '#6366f1', 600: '#4f46e5', 900: '#312e81' },
            dark: { 950: '#020617', 900: '#0f172a', 800: '#1e293b' }
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out forwards',
            'slide-up': 'slideUp 0.3s ease-out forwards',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>
  <style>
    body { background-color: #020617; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
    .glass { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
    .modal-glass { background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .nav-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
    .nav-item.active { background: rgba(99, 102, 241, 0.1); color: #818cf8; border-left-color: #6366f1; }
    .loading { opacity: 0.6; pointer-events: none; }
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #6366f1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden-role { display: none; }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body class="flex h-screen overflow-hidden select-none bg-dark-950 font-sans">
  <div id="splash-screen" class="fixed inset-0 z-[100] bg-dark-950 flex flex-col items-center justify-center transition-opacity duration-700">
    <div class="w-20 h-20 rounded-2xl bg-gradient-to-tr from-brand-600 to-indigo-400 flex items-center justify-center text-white font-bold text-4xl mb-6 shadow-2xl shadow-brand-500/20">i8</div>
    <p class="text-white text-lg font-bold">Insightful Eight Ltd</p>
    <p class="text-slate-500 text-xs font-bold uppercase tracking-[0.2em] mt-2 animate-pulse">Loading System v1.0.0</p> <!-- Fixed version -->
  </div>

  <!-- Auth/Register screens unchanged from previous -->

  <div id="toast-box" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[200] flex flex-col gap-3 w-full max-w-sm px-4 pointer-events-none"></div>

  <div id="portal-member" class="hidden flex w-full h-full transition-all duration-500 transform scale-100 opacity-100 origin-center">
    <!-- Sidebar/nav unchanged, but admin switch onclick="App.switchToAdmin()" (new func with PIN prompt) -->
    <aside class="hidden md:flex flex-col w-72 bg-dark-950/50 backdrop-blur-xl border-r border-dark-800 z-20">
      <!-- ... nav as before ... -->
      <div id="admin-switch-container" class="mt-auto border-t border-white/5 pt-4">
        <button onclick="App.switchToAdmin()" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-amber-500 font-medium hover:bg-amber-500/10 border-l-4 border-transparent hover:border-amber-500 transition group"><i class="fa-solid fa-shield-halved w-5 group-hover:scale-110 transition"></i> Executive Admin</button>
      </div>
      <!-- Logout as before -->
    </aside>

    <!-- Main unchanged, dashboard fetches as before -->

  </div>

  <!-- Modals unchanged -->

  <!-- New: Admin PIN Modal -->
  <div id="modal-admin-pin" class="hidden absolute inset-0 z-[70] bg-dark-950/90 backdrop-blur flex items-center justify-center">
    <div class="glass p-8 rounded-2xl w-full max-w-xs text-center">
      <h3 class="text-xl font-bold text-white mb-2">Admin PIN Required</h3>
      <input type="password" id="admin-pin-input" maxlength="4" class="bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-3 w-full outline-none focus:border-brand-500 transition mb-4" placeholder="••••">
      <button onclick="App.verifyAdminPin()" class="w-full bg-amber-600 text-white font-bold py-3 rounded-xl hover:bg-amber-500"><span id="admin-pin-spinner" class="spinner hidden"></span>Unlock Admin</button>
      <button onclick="document.getElementById('modal-admin-pin').classList.add('hidden')" class="mt-4 text-xs text-slate-500 hover:text-white">Cancel</button>
    </div>
  </div>

  <div id="portal-admin" class="hidden fixed inset-0 z-50 bg-dark-950 flex flex-col transition-all duration-300 transform opacity-0 scale-95">
    <!-- Header unchanged -->

    <main class="flex-1 relative overflow-hidden bg-gradient-to-br from-dark-950 via-[#0f1221] to-dark-950 p-6 md:p-10 overflow-y-auto">
      <div id="admin-screen-login" class="flex flex-col items-center justify-center h-full">
        <!-- Role buttons as before, but onclick="App.adminLogin(role)" hides non-matching for currentUserRole -->
      </div>

      <!-- Role Dashboards (enhanced) -->
      <div id="view-admin-secretary" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="glass p-6 rounded-2xl">
          <h3 class="font-bold text-white mb-4">Publish Minutes</h3>
          <textarea id="minutes-text" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white h-24 mb-2" placeholder="Minutes content..."></textarea>
          <button onclick="App.submitMinutes()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-500"><span id="minutes-spinner" class="spinner hidden"></span>Submit to Chair</button>
        </div>
        <div class="glass p-6 rounded-2xl">
          <h3 class="font-bold text-white mb-4">Upload Documents</h3>
          <input type="file" id="doc-upload" class="hidden" accept=".pdf,.docx" onchange="App.handleDocUpload(event)">
          <button onclick="document.getElementById('doc-upload').click()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-500">Upload Constitution/Calendar</button>
          <span id="doc-name" class="text-xs text-slate-400"></span>
        </div>
        <!-- Queue view, handover as before -->
      </div>

      <div id="view-admin-treasurer" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="glass p-6 rounded-2xl">
          <h3 class="font-bold text-white mb-4">Financial Reports</h3>
          <textarea id="report-text" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white h-24 mb-2" placeholder="Report details..."></textarea>
          <input type="file" id="report-file" class="hidden" accept=".pdf" onchange="App.handleReportUpload(event)">
          <button onclick="document.getElementById('report-file').click()" class="bg-emerald-600 text-white px-4 py-2 rounded mr-2">Upload File</button>
          <button onclick="App.submitReport()" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-emerald-500"><span id="report-spinner" class="spinner hidden"></span>Submit to Chair</button>
        </div>
        <div class="glass p-6 rounded-2xl">
          <h3 class="font-bold text-white mb-4">Pending Loans</h3>
          <div id="pending-loans" class="space-y-2"></div>
        </div>
        <!-- Handover -->
      </div>

      <div id="view-admin-chairperson" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="glass p-6 rounded-2xl">
          <h3 class="font-bold text-white mb-4">Approval Queue</h3>
          <div id="chair-queue" class="space-y-3"></div>
        </div>
        <!-- Promote form as before -->
        <!-- Handover, analytics -->
      </div>

      <div id="view-admin-supervisorycommittee" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="glass p-6 rounded-2xl border-l-4 border-gray-500">
          <h3 class="font-bold text-white mb-4">All Activities</h3>
          <div id="sup-logs" class="space-y-2"></div>
          <button onclick="App.exportAudit()" class="bg-gray-600 text-white px-4 py-2 rounded mt-4"><span id="export-spinner" class="spinner hidden"></span>Download Audit CSV</button>
        </div>
        <!-- Handover -->
      </div>

      <div id="view-admin-committeemember" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="glass p-6 rounded-2xl border-l-4 border-orange-500">
          <h3 class="font-bold text-white mb-4">View & Note Queues</h3>
          <div id="cm-queue" class="space-y-4"></div>
          <textarea id="cm-note" class="w-full bg-dark-950 border border-white/10 rounded-xl p-2 text-white" placeholder="Add opinion..."></textarea>
          <button onclick="App.addNote()" class="bg-orange-600 text-white px-4 py-2 rounded">Submit Note</button>
        </div>
        <!-- Handover -->
      </div>
    </main>
  </div>

  <script>
    const API_BASE = 'https://app-backend-xil0.onrender.com';
    let userToken = localStorage.getItem('token') || '';
    let currentUserRole = 'member';
    const App = {
      // ... utils, auth, nav as before, but switchToAdmin: show PIN modal -->

      switchToAdmin: () => {
        document.getElementById('modal-admin-pin').classList.remove('hidden');
      },

      verifyAdminPin: async () => {
        const pin = document.getElementById('admin-pin-input').value;
        if (pin.length !== 4) return App.toast('4-digit PIN required', 'error');
        App.showSpinner('admin-pin-spinner');
        try {
          const data = await App.fetchWithAuth('/auth/admin-pin', { method: 'POST', body: JSON.stringify({ pin }) });
          userToken = data.token;
          localStorage.setItem('token', userToken);
          document.getElementById('modal-admin-pin').classList.add('hidden');
          App.switchContext('admin');
        } catch (err) {
          App.toast(err.message || 'Invalid PIN', 'error');
        } finally {
          App.showSpinner('admin-pin-spinner', false);
          document.getElementById('admin-pin-input').value = '';
        }
      },

      // Render enhancements: Fetch pending loans for treasurer
      renderAll: async () => {
        // ... as before, plus
        if (currentUserRole === 'treasurer') App.renderPendingLoans();
      },

      renderPendingLoans: async () => {
        try {
          const loans = await App.fetchWithAuth('/loans?status=Pending');
          const container = document.getElementById('pending-loans');
          container.innerHTML = loans.map(l => `
            <div class="p-3 bg-white/5 rounded">
              <strong>${l.member}: ${l.purpose} (KES ${l.amount})</strong>
              <button onclick="App.approveLoan(${l.id}, 'Treas Approved')" class="bg-emerald-600 text-white px-3 py-1 rounded ml-2"><span id="loan-${l.id}-spinner" class="spinner hidden"></span>Approve</button>
              <button onclick="App.approveLoan(${l.id}, 'Rejected')" class="bg-red-600 text-white px-3 py-1 rounded ml-2">Reject</button>
            </div>
          `).join('') || '<p>No pending loans</p>';
        } catch (err) {
          App.toast('Failed to load loans', 'error');
        }
      },

      approveLoan: async (id, status) => {
        const notes = prompt('Notes (optional):');
        App.showSpinner(`loan-${id}-spinner`);
        try {
          await App.fetchWithAuth(`/loans/${id}`, { method: 'PATCH', body: JSON.stringify({ status, notes }) });
          App.toast('Loan updated', 'success');
          await App.renderPendingLoans();
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner(`loan-${id}-spinner`, false);
        }
      },

      submitMinutes: async () => {
        const text = document.getElementById('minutes-text').value.trim();
        if (!text) return App.toast('Minutes required', 'error');
        App.showSpinner('minutes-spinner');
        try {
          await App.fetchWithAuth('/chair-queue', { method: 'POST', body: JSON.stringify({ type: 'Minutes', data: { text }, author: 'Secretary' }) });
          App.toast('Minutes queued for approval', 'success');
          document.getElementById('minutes-text').value = '';
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('minutes-spinner', false);
        }
      },

      handleDocUpload: (e) => {
        const file = e.target.files[0];
        if (file) document.getElementById('doc-name').textContent = `Uploaded: ${file.name}`;
        // POST to approved-reports or queue
      },

      submitReport: async () => {
        const text = document.getElementById('report-text').value.trim();
        const file = document.getElementById('report-file').files[0]?.name || '';
        if (!text) return App.toast('Report required', 'error');
        App.showSpinner('report-spinner');
        try {
          await App.fetchWithAuth('/chair-queue', { method: 'POST', body: JSON.stringify({ type: 'Report', data: { text, file }, author: 'Treasurer' }) });
          App.toast('Report queued', 'success');
          document.getElementById('report-text').value = '';
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('report-spinner', false);
        }
      },

      // Chair approve
      approveQueueItem: async (id, signature) => {
        App.showSpinner(`approve-${id}-spinner`);
        try {
          await App.fetchWithAuth(`/chair-queue/${id}/approve`, { method: 'PATCH', body: JSON.stringify({ signature }) });
          App.toast('Approved & published', 'success');
          await App.renderChairQueue();
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner(`approve-${id}-spinner`, false);
        }
      },

      renderChairQueue: async () => {
        const queue = await App.fetchWithAuth('/chair-queue');
        document.getElementById('chair-queue').innerHTML = queue.map(q => `
          <div class="p-3 bg-purple-900/20 rounded">
            <strong>${q.type}: ${q.data.purpose || q.data.text?.substring(0,50)}...</strong> by ${q.author}
            <button onclick="App.approveQueueItem('${q.id}', prompt('Signature:'))" class="bg-purple-600 text-white px-3 py-1 rounded ml-2"><span id="approve-${q.id}-spinner" class="spinner hidden"></span>Approve & Sign</button>
          </div>
        `).join('') || '<p>No pending</p>';
      },

      // Supervisory export
      exportAudit: async () => {
        App.showSpinner('export-spinner');
        try {
          const response = await fetch(`${API_BASE}/export/logs`, { headers: { 'Authorization': `Bearer ${userToken}` } });
          if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'audit.csv';
            a.click();
            App.toast('Audit exported', 'success');
          }
        } catch (err) {
          App.toast('Export failed', 'error');
        } finally {
          App.showSpinner('export-spinner', false);
        }
      },

      addNote: async () => {
        const note = document.getElementById('cm-note').value.trim();
        if (!note) return App.toast('Note required', 'error');
        try {
          await App.fetchWithAuth('/chair-queue', { method: 'POST', body: JSON.stringify({ type: 'Committee Note', data: { note }, author: 'Committee' }) });
          App.toast('Note added', 'success');
          document.getElementById('cm-note').value = '';
        } catch (err) {
          App.toast(err.message, 'error');
        }
      },

      // Role guard in adminLogin
      adminLogin: (role) => {
        if (role !== currentUserRole) return App.toast('Role mismatch', 'error');
        document.getElementById('admin-screen-login').classList.add('hidden');
        document.getElementById(`view-admin-${role}`).classList.remove('hidden');
        // Hide non-relevant sections
        document.querySelectorAll('.hidden-role').forEach(el => el.classList.add('hidden'));
        if (role === 'chairperson') App.renderChairQueue();
        if (role === 'treasurer') App.renderPendingLoans();
        // Similar for others
        const badge = document.getElementById('admin-badge');
        badge.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        badge.className = 'text-[10px] bg-white/10 px-2 py-0.5 rounded text-green-400 ml-2 uppercase';
      },

      // ... other methods as before (renderAll fetches queue/loans by role)
    };

    // ... onload as before
  </script>
</body>
</html>
