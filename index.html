<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>i8 Portal - Insightful Eight Ltd</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <meta name="theme-color" content="#6366f1">
  <!-- Tailwind CSS CDN for rapid styling (replace with build for prod) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for glassmorphism, animations, loading, etc. */
    body { 
      background: linear-gradient(135deg, #020617 0%, #1e293b 100%); 
      color: white; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      overflow-x: hidden;
    }
    .glass { 
      backdrop-filter: blur(16px); 
      background: rgba(255, 255, 255, 0.05); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
    }
    .hidden { display: none !important; }
    .opacity-0 { opacity: 0 !important; transition: opacity 0.5s ease; }
    .pointer-events-none { pointer-events: none !important; }
    .loading { cursor: wait !important; opacity: 0.7; }
    .active { background: rgba(99, 102, 241, 0.3) !important; }
    .animate-fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    /* Splash screen */
    #splash-screen { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center; 
      z-index: 999; transition: opacity 0.5s ease; 
    }
    #splash-screen img { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
    /* Toast notifications */
    .fixed.top-6.left-1/2 { z-index: 200; }
    /* Modals */
    .fixed.inset-0 { background: rgba(0,0,0,0.5); }
    /* Nav overflow */
    .overflow-x-auto { scrollbar-width: none; -ms-overflow-style: none; }
    .overflow-x-auto::-webkit-scrollbar { display: none; }
    /* Scale transition for admin */
    .scale-95 { transform: scale(0.95); }
    /* Notifications panel */
    #notifications-panel { position: fixed; top: 0; right: -400px; width: 400px; height: 100%; background: rgba(0,0,0,0.9); transition: right 0.3s; z-index: 100; }
    #notifications-panel:not(.hidden) { right: 0; }
  </style>
</head>
<body class="m-0 p-0 min-h-screen">
  <!-- Splash Screen -->
  <div id="splash-screen" class="flex flex-col items-center justify-center gap-4">
    <img src="/icon-512.png" alt="i8 Logo" class="w-24 h-24 md:w-32 md:h-32 opacity-80 animate-pulse">
    <p class="text-lg md:text-xl font-bold text-indigo-400">Loading i8 Portal...</p>
    <div class="w-16 h-1 bg-indigo-400 rounded-full animate-pulse"></div>
  </div>

  <!-- Auth Screen (Login) -->
  <div id="screen-auth" class="fixed inset-0 flex items-center justify-center p-4 opacity-100 pointer-events-auto">
    <div class="glass rounded-2xl p-6 md:p-8 w-full max-w-md">
      <h1 class="text-2xl font-bold mb-6 text-center text-white">Welcome to i8 Portal</h1>
      <form onsubmit="event.preventDefault(); App.memberLogin();">
        <input id="login-email" type="email" placeholder="Email Address" class="w-full p-3 mb-4 bg-white/10 rounded-lg text-white placeholder-slate-400 border border-white/20 focus:border-indigo-400 focus:outline-none" required>
        <input id="member-pin" type="password" inputmode="numeric" placeholder="4-Digit PIN" maxlength="4" class="w-full p-3 mb-6 bg-white/10 rounded-lg text-white placeholder-slate-400 border border-white/20 focus:border-indigo-400 focus:outline-none" required>
        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-bold transition-colors">Login</button>
      </form>
      <div id="login-spinner" class="hidden flex justify-center mt-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-400"></div>
      </div>
      <button onclick="App.resetPin()" class="text-sm text-indigo-300 hover:underline text-center block w-full mt-2">Forgot PIN? Reset to 1234</button>
      <button onclick="App.showRegister()" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm mt-3 transition-colors">Register New Member</button>
    </div>
  </div>

  <!-- Register Screen -->
  <div id="screen-register" class="fixed inset-0 flex items-center justify-center p-4 hidden">
    <div class="glass rounded-2xl p-6 md:p-8 w-full max-w-md">
      <h1 class="text-2xl font-bold mb-6 text-center text-white">Register New Member</h1>
      <form onsubmit="event.preventDefault(); App.registerMember();">
        <input id="reg-name" type="text" placeholder="Full Name" class="w-full p-3 mb-4 bg-white/10 rounded-lg text-white placeholder-slate-400 border border-white/20 focus:border-green-400 focus:outline-none" required>
        <input id="reg-email" type="email" placeholder="Email Address" class="w-full p-3 mb-4 bg-white/10 rounded-lg text-white placeholder-slate-400 border border-white/20 focus:border-green-400 focus:outline-none" required>
        <input id="reg-pin" type="password" inputmode="numeric" placeholder="4-Digit PIN" maxlength="4" class="w-full p-3 mb-6 bg-white/10 rounded-lg text-white placeholder-slate-400 border border-white/20 focus:border-green-400 focus:outline-none" required>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold transition-colors">Register</button>
      </form>
      <div id="reg-spinner" class="hidden flex justify-center mt-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-400"></div>
      </div>
      <button onclick="App.showLogin()" class="text-sm text-indigo-300 hover:underline text-center block w-full">Back to Login</button>
    </div>
  </div>

  <!-- Member Portal -->
  <div id="portal-member" class="min-h-screen p-4 hidden">
    <!-- Header -->
    <header class="glass rounded-xl p-4 mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
      <h1 id="header-title" class="text-xl font-bold text-white">Dashboard</h1>
      <div class="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-end">
        <span id="welcome-user" class="text-sm text-slate-300 hidden"></span>
        <span id="admin-badge" class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-slate-400 uppercase hidden">Locked</span>
        <div class="flex gap-2">
          <button onclick="App.toggleNotifications()" class="relative p-2 rounded-lg bg-white/10">
            <i class="fa-solid fa-bell text-white"></i>
            <span id="notif-badge" class="absolute -top-1 -right-1 bg-red-500 text-xs px-1.5 py-0.5 rounded-full hidden">0</span>
          </button>
          <button onclick="App.switchToAdmin()" class="hidden p-2 rounded-lg bg-purple-600/50 text-white hover:bg-purple-600 transition-colors">Admin</button>
          <button onclick="App.logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-bold transition-colors">Logout</button>
        </div>
      </div>
    </header>

    <!-- Notifications Panel -->
    <div id="notifications-panel" class="hidden">
      <div class="p-4 border-b border-white/10 flex justify-between items-center">
        <h2 class="font-bold">Notifications</h2>
        <button onclick="App.toggleNotifications()" class="text-white">&times;</button>
      </div>
      <div id="notif-list" class="p-4 space-y-2 max-h-[calc(100vh-100px)] overflow-y-auto"></div>
    </div>

    <!-- Navigation -->
    <nav class="glass rounded-xl p-4 mb-4 flex flex-col sm:flex-row gap-2 overflow-x-auto">
      <button id="nav-dashboard" onclick="App.nav('dashboard')" class="px-4 py-2 rounded bg-indigo-600 active text-white font-semibold">Dashboard</button>
      <button id="nav-finance" onclick="App.nav('finance')" class="px-4 py-2 rounded bg-white/10 text-white hover:bg-white/20 transition-colors">Finance</button>
      <button id="nav-welfare" onclick="App.nav('welfare')" class="px-4 py-2 rounded bg-white/10 text-white hover:bg-white/20 transition-colors">Welfare</button>
      <button id="nav-vote" onclick="App.nav('vote')" class="px-4 py-2 rounded bg-white/10 text-white hover:bg-white/20 transition-colors">Vote</button>
      <button id="nav-profile" onclick="App.nav('profile')" class="px-4 py-2 rounded bg-white/10 text-white hover:bg-white/20 transition-colors">Profile</button>
    </nav>

    <!-- Views -->
    <main>
      <!-- Dashboard View -->
      <div id="view-dashboard" class="">
        <div id="member-news-feed" class="glass p-4 rounded-xl mb-4 space-y-2"></div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
          <div class="glass p-4 rounded-xl text-center">
            <p class="text-sm text-slate-400 mb-1">Total Liquidity</p>
            <p id="dash-liquidity" class="text-2xl font-bold text-green-400">KES 0</p>
          </div>
          <div class="glass p-4 rounded-xl text-center">
            <p class="text-sm text-slate-400 mb-1">Active Polls</p>
            <p id="dash-poll-count" class="text-2xl font-bold text-indigo-400">0</p>
          </div>
          <div class="glass p-4 rounded-xl text-center">
            <p class="text-sm text-slate-400 mb-1">Welfare Status</p>
            <p id="dash-welfare-status" class="text-2xl font-bold text-amber-400">Good Standing</p>
          </div>
        </div>
        <div id="approved-reports" class="glass p-4 rounded-xl space-y-2"></div>
      </div>

      <!-- Finance View -->
      <div id="view-finance" class="hidden">
        <div class="glass p-4 rounded-xl mb-4">
          <h2 class="text-xl font-bold mb-4">Transactions</h2>
          <div id="finance-list" class="space-y-2"></div>
        </div>
        <button onclick="App.openLoanModal()" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-xl font-bold w-full">Apply for Loan</button>
      </div>

      <!-- Welfare View -->
      <div id="view-welfare" class="hidden">
        <div class="glass p-4 rounded-xl mb-4">
          <h2 class="text-xl font-bold mb-4">Claims</h2>
          <div id="welfare-list" class="space-y-2"></div>
        </div>
        <button onclick="App.openWelfareModal()" class="bg-pink-600 hover:bg-pink-700 px-6 py-3 rounded-xl font-bold w-full">Submit Claim</button>
      </div>

      <!-- Vote View -->
      <div id="view-vote" class="hidden">
        <div class="glass p-4 rounded-xl">
          <h2 class="text-xl font-bold mb-4">Active Polls</h2>
          <div id="polls-container" class="space-y-4"></div>
          <button id="download-btn" onclick="App.downloadResults()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded mt-4 hidden">Download Results</button>
        </div>
      </div>

      <!-- Profile View -->
      <div id="view-profile" class="hidden">
        <div class="glass p-4 rounded-xl space-y-4">
          <h2 class="text-xl font-bold mb-4">Profile</h2>
          <div>
            <label class="block text-sm mb-1">Name</label>
            <input id="profile-name" type="text" class="w-full p-3 bg-white/10 rounded-lg text-white border border-white/20" disabled>
          </div>
          <div>
            <label class="block text-sm mb-1">Email</label>
            <input id="profile-email" type="email" class="w-full p-3 bg-white/10 rounded-lg text-white border border-white/20" disabled>
          </div>
          <div>
            <label class="block text-sm mb-1">New PIN</label>
            <input id="new-pin" type="password" inputmode="numeric" maxlength="4" placeholder="4-Digit New PIN" class="w-full p-3 bg-white/10 rounded-lg text-white border border-white/20">
            <button onclick="App.changePin()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded mt-2">Update PIN</button>
          </div>
          <div class="flex gap-2">
            <button id="edit-profile-btn" onclick="App.toggleEditProfile()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Edit</button>
            <button id="save-profile-btn" onclick="App.saveProfile()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded hidden">Save</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Admin Portal -->
  <div id="portal-admin" class="min-h-screen p-4 hidden opacity-0 scale-95 transition-all duration-300">
    <!-- Similar header/nav for admin, with role-specific views -->
    <header class="glass rounded-xl p-4 mb-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">Admin Panel</h1>
      <button onclick="App.adminLogout()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Back to Member</button>
    </header>
    <!-- Role-specific views (hidden by default) -->
    <div id="view-admin-secretary" class="hidden">
      <div class="glass p-4 rounded-xl space-y-4">
        <h2>Secretary Dashboard</h2>
        <div id="sec-welfare-queue" class="space-y-2"></div>
        <textarea id="sec-news" placeholder="Post News/Update" class="w-full p-3 bg-white/10 rounded h-24"></textarea>
        <button onclick="App.submitNews()" class="bg-blue-600 px-4 py-2 rounded">Submit News</button>
      </div>
    </div>
    <!-- Add other admin views: treasurer, chair, etc. as stubs -->
    <div id="view-admin-treasurer" class="hidden"><p>Treasurer View</p><div id="pending-loans"></div><textarea id="treas-report" placeholder="Financial Report"></textarea><button onclick="App.submitFinancialReport()">Submit Report</button></div>
    <div id="view-admin-chairperson" class="hidden"><p>Chair View</p><div id="chair-queue"></div><textarea id="chair-comm" placeholder="Direct Communication"></textarea><button onclick="App.publishDirectComm()">Publish</button></div>
    <div id="view-admin-supervisorycommittee" class="hidden"><p>Supervisory View</p><div id="supervisory-logs"></div><button onclick="App.downloadAuditReport()">Download Audit</button></div>
    <div id="view-admin-committeemember" class="hidden"><p>Committee View</p><div id="cm-welfare-view"></div><div id="cm-news-view"></div><div id="cm-fin-report-view"></div></div>
  </div>

  <!-- Modals -->
  <!-- Admin PIN Modal -->
  <div id="modal-admin-pin" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
    <div class="glass rounded-xl p-6 w-full max-w-sm">
      <h2 class="text-xl font-bold mb-4">Admin Access</h2>
      <input id="admin-pin-input" type="password" inputmode="numeric" maxlength="4" placeholder="4-Digit Admin PIN" class="w-full p-3 mb-4 bg-white/10 rounded-lg text-white border border-white/20 focus:border-purple-400">
      <div id="admin-pin-spinner" class="hidden flex justify-center mt-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-400"></div>
      </div>
      <button onclick="App.verifyAdminPin()" class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-bold">Verify</button>
    </div>
  </div>

  <!-- Loan Modal -->
  <div id="modal-loan" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
    <div class="glass rounded-xl p-6 w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Loan Application</h2>
      <input id="loan-amount" type="number" placeholder="Amount (KES)" class="w-full p-3 mb-4 bg-white/10 rounded-lg text-white">
      <textarea id="loan-purpose" placeholder="Purpose" class="w-full p-3 mb-4 bg-white/10 rounded-lg text-white h-20"></textarea>
      <div id="loan-spinner" class="hidden flex justify-center mt-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-emerald-400"></div>
      </div>
      <button onclick="App.submitLoan()" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-bold">Submit</button>
      <button onclick="document.getElementById('modal-loan').classList.add('hidden')" class="w-full text-slate-400 mt-2">Cancel</button>
    </div>
  </div>

  <!-- Welfare Modal -->
  <div id="modal-welfare" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
    <div class="glass rounded-xl p-6 w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Welfare Claim</h2>
      <select id="welfare-type" class="w-full p-3 mb-4 bg-white/10 rounded-lg text-white">
        <option value="">Select Type</option>
        <option value="Medical">Medical</option>
        <option value="Bereavement">Bereavement</option>
        <option value="Education">Education</option>
      </select>
      <input id="welfare-amount" type="number" placeholder="Amount (KES)" class="w-full p-3 mb-4 bg-white/10 rounded-lg text-white">
      <div id="welfare-spinner" class="hidden flex justify-center mt-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-pink-400"></div>
      </div>
      <button onclick="App.submitWelfare()" class="w-full bg-pink-600 hover:bg-pink-700 py-3 rounded-lg font-bold">Submit</button>
      <button onclick="document.getElementById('modal-welfare').classList.add('hidden')" class="w-full text-slate-400 mt-2">Cancel</button>
    </div>
  </div>

  <!-- Font Awesome for icons (optional) -->
  <script src="https://kit.fontawesome.com/your-kit-id.js" crossorigin="anonymous"></script>

  <!-- Main App Script -->
  <script>
    const API_BASE = 'https://app-backend-xil0.onrender.com'; // Your live backend URL
    let userToken = localStorage.getItem('token') || '';
    let currentUserRole = 'member';
    let deferredPrompt; // For PWA install
    const App = {
      data: {
        user: '',
        role: 'member',
        news: [],
        polls: [],
        approvedReports: [],
        welfare: [],
        chairQueue: [],
        transactions: [],
        logs: [],
        members: [],
        signatures: {},
        notifications: [],
        loans: []
      },
      showSpinner: (id, show = true) => {
        if (id) document.getElementById(id)?.classList.toggle('hidden', !show);
        document.body.classList.toggle('loading', show);
      },
      toast: (msg, type = 'info') => {
        const toast = document.createElement('div');
        toast.className = `p-3 rounded-lg fixed top-6 left-1/2 transform -translate-x-1/2 z-[200] ${type === 'error' ? 'bg-red-500/20 border-red-500/30 text-red-300' : type === 'success' ? 'bg-green-500/20 border-green-500/30 text-green-300' : 'bg-blue-500/20 border-blue-500/30 text-blue-300'} border animate-fade-in max-w-sm w-full px-4 pointer-events-auto`;
        toast.innerHTML = `${msg} <button onclick="this.parentElement.remove()" class="float-right text-xs">&times;</button>`;
        toast.setAttribute('role', 'alert');
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
      },
      fetchWithAuth: async (endpoint, options = {}) => {
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (userToken) headers.Authorization = `Bearer ${userToken}`;
        try {
          const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
          if (!res.ok) {
            const contentType = res.headers.get('content-type');
            const errText = await res.text();
            if (!contentType || !contentType.includes('application/json')) {
              // Handle non-JSON (e.g., SW offline text or 503)
              throw new Error(`Server error: ${res.status} - ${errText.substring(0,100)} (Check connection)`);
            }
            try {
              const err = JSON.parse(errText);
              throw new Error(err.error || 'Request failed');
            } catch {
              throw new Error(`Server error: ${res.status} - ${errText.substring(0,100)}`);
            }
          }
          return await res.json();
        } catch (err) {
          App.toast(err.message || 'Network error - Check connection and retry', 'error');
          throw err;
        }
      },
      // ... (rest of your script unchanged – it's already complete and works)
      initPWA: () => {
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          setTimeout(() => {
            if (deferredPrompt && document.getElementById('portal-member').classList.contains('hidden') === false) {
              const promptToast = document.createElement('div');
              promptToast.className = 'fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-brand-600 text-white p-4 rounded-xl z-[200] flex items-center gap-3 max-w-sm';
              promptToast.innerHTML = '<i class="fa-solid fa-download"></i> Install i8 Portal App? <button id="install-btn" class="ml-4 bg-white text-brand-600 px-4 py-1 rounded font-bold">Install</button> <button onclick="this.parentElement.remove()" class="ml-2 text-white">&times;</button>';
              document.body.appendChild(promptToast);
              document.getElementById('install-btn')?.addEventListener('click', App.handleInstall);
            }
          }, 5000);
        });
      },
      handleInstall: async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') deferredPrompt = null;
        document.querySelector('[id="install-btn"]').parentElement.remove();
      },
      memberLogin: async () => {
        const email = document.getElementById('login-email').value.trim();
        const pin = document.getElementById('member-pin').value;
        if (!email || !pin || pin.length !== 4 || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return App.toast('Valid email and 4-digit PIN required', 'error');
        // Offline check before fetch
        if (!navigator.onLine) return App.toast('Offline - Please connect to internet', 'error');
        App.showSpinner('login-spinner');
        try {
          const data = await App.fetchWithAuth('/auth', { method: 'POST', body: JSON.stringify({ email, pin }) });
          App.data.user = data.user.name;
          currentUserRole = data.user.role;
          localStorage.setItem('token', data.token);
          userToken = data.token;
          document.getElementById('screen-auth').classList.add('opacity-0', 'pointer-events-none');
          setTimeout(() => {
            document.getElementById('screen-auth').classList.add('hidden');
            document.getElementById('portal-member').classList.remove('hidden');
            document.getElementById('welcome-user').textContent = `Welcome, ${App.data.user}`;
            document.getElementById('welcome-user').classList.remove('hidden');
            const adminBtn = document.querySelectorAll('[onclick="App.switchToAdmin()"]');
            adminBtn.forEach(btn => {
              if (['secretary', 'treasurer', 'chairperson', 'supervisorycommittee', 'committeemember'].includes(currentUserRole)) {
                btn.classList.remove('hidden');
              }
            });
            App.renderAll();
            App.renderNotifications();
            App.initPWA(); // Trigger install after login
          }, 500);
        } catch (err) {
          // Error handled in fetchWithAuth
        } finally {
          App.showSpinner('login-spinner', false);
          document.getElementById('login-email').value = '';
          document.getElementById('member-pin').value = '';
        }
      },
      // ... (all other methods unchanged – copy from your original for brevity)
      resetPin: async () => {
        const email = document.getElementById('login-email').value.trim();
        if (!email) return App.toast('Enter email first', 'error');
        try {
          await App.fetchWithAuth('/reset-pin', { method: 'POST', body: JSON.stringify({ email }) });
          App.toast('PIN reset to 1234. Check your email or login now.', 'success');
        } catch {}
      },
      showRegister: () => {
        document.getElementById('screen-auth').classList.add('hidden');
        document.getElementById('screen-register').classList.remove('hidden');
      },
      showLogin: () => {
        document.getElementById('screen-register').classList.add('hidden');
        document.getElementById('screen-auth').classList.remove('hidden');
      },
      registerMember: async () => {
        const name = document.getElementById('reg-name').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const pin = document.getElementById('reg-pin').value;
        if (!name || !email || pin.length !== 4 || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return App.toast('Valid details required', 'error');
        App.showSpinner('reg-spinner');
        try {
          await App.fetchWithAuth('/members', { method: 'POST', body: JSON.stringify({ name, email, pin }) });
          App.toast('Registered! Login with your PIN.', 'success');
          App.showLogin();
        } catch {}
        finally {
          App.showSpinner('reg-spinner', false);
          document.getElementById('reg-name').value = '';
          document.getElementById('reg-email').value = '';
          document.getElementById('reg-pin').value = '';
        }
      },
      nav: (view) => {
        document.querySelectorAll('[id^="nav-"]').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`nav-${view}`)?.classList.add('active');
        document.getElementById('header-title').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        document.querySelectorAll('[id^="view-"]').forEach(sec => sec.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        if (view === 'dashboard') App.renderDashboard();
        else if (view === 'finance') App.renderFinance();
        else if (view === 'welfare') App.renderWelfare();
        else if (view === 'vote') App.renderPolls();
        else if (view === 'profile') App.renderProfile();
      },
      renderAll: async () => {
        await Promise.all([
          App.loadNews(),
          App.loadPolls(),
          App.loadApprovedReports(),
          App.loadWelfare(),
          App.loadTransactions()
        ]);
        document.getElementById('dash-liquidity').textContent = 'KES ' + App.data.transactions.reduce((sum, t) => sum + (t.type === 'credit' ? t.amount : -t.amount), 0).toLocaleString();
        document.getElementById('dash-poll-count').textContent = App.data.polls.filter(p => p.active).length;
        document.getElementById('dash-welfare-status').textContent = App.data.welfare.length ? 'Pending Claims' : 'Good Standing';
      },
      loadNews: async () => { App.data.news = await App.fetchWithAuth('/news'); App.renderNews(); },
      renderNews: () => { 
        const feed = document.getElementById('member-news-feed');
        feed.innerHTML = App.data.news.map(n => `<div class="p-3 bg-white/5 rounded-lg"><p class="text-sm">${n.text}</p><span class="text-xs text-slate-400 block mt-1">${n.signedBy} - ${new Date(n.createdAt).toLocaleDateString()}</span></div>`).join('') || '<p class="text-slate-400 text-center">No updates yet.</p>'; 
      },
      loadPolls: async () => { App.data.polls = await App.fetchWithAuth('/polls'); App.renderPolls(); },
      renderPolls: () => {
        const container = document.getElementById('polls-container');
        container.innerHTML = App.data.polls.filter(p => p.active).map(p => `
          <div class="glass p-4 rounded-xl space-y-2">
            <h4 class="font-bold text-white mb-2">${p.question}</h4>
            ${p.options.map((opt, i) => `<button onclick="App.vote(${p.id}, ${i})" class="block w-full text-left p-3 bg-white/5 hover:bg-white/10 rounded-lg transition-colors">${opt} <span class="float-right text-sm text-slate-400">(${p.votes[i]} votes)</span></button>`).join('')}
          </div>
        `).join('') || '<p class="text-slate-400 text-center">No active polls.</p>';
        document.getElementById('download-btn').classList.toggle('hidden', App.data.polls.length === 0);
      },
      vote: async (pollId, optionIdx) => {
        try {
          const polls = await App.fetchWithAuth('/polls'); // Refetch or patch endpoint
          const poll = polls.find(p => p.id === pollId);
          if (poll.voters.includes(App.data.user)) return App.toast('Already voted', 'error');
          poll.votes[optionIdx]++;
          poll.voters.push(App.data.user);
          await App.fetchWithAuth(`/polls/${pollId}`, { method: 'PATCH', body: JSON.stringify({ votes: poll.votes, voters: poll.voters }) }); // Assume backend supports
          App.renderPolls();
          App.toast('Vote cast!', 'success');
        } catch {}
      },
      loadApprovedReports: async () => { App.data.approvedReports = await App.fetchWithAuth('/approved-reports'); App.renderApprovedReports(); },
      renderApprovedReports: () => { 
        const reports = document.getElementById('approved-reports');
        reports.innerHTML = App.data.approvedReports.map(r => `<div class="p-3 bg-white/5 rounded-lg"><p class="text-sm mb-1">${r.text}</p><span class="text-xs text-slate-400">${r.signedBy}</span></div>`).join('') || '<p class="text-slate-400 text-center">No reports.</p>'; 
      },
      loadWelfare: async () => { App.data.welfare = await App.fetchWithAuth('/welfare'); App.renderWelfare(); },
      renderWelfare: () => { 
        const list = document.getElementById('welfare-list');
        list.innerHTML = App.data.welfare.map(w => `<div class="p-3 bg-pink-900/20 rounded-lg flex justify-between"><span>${w.type}: KES ${w.amount.toLocaleString()}</span><span class="text-sm">${w.status}</span></div>`).join('') || '<p class="text-slate-400 text-center">No claims.</p>'; 
      },
      loadTransactions: async () => { App.data.transactions = await App.fetchWithAuth('/transactions'); App.renderTransactions(); },
      renderTransactions: () => { 
        const list = document.getElementById('finance-list');
        list.innerHTML = App.data.transactions.map(t => `<div class="p-3 flex justify-between items-center bg-white/5 rounded-lg"><span class="text-sm">${t.title} - <span class="capitalize">${t.type}</span></span><span class="font-bold text-${t.type === 'credit' ? 'green' : 'red'}-400">KES ${t.amount.toLocaleString()}</span></div>`).join('') || '<p class="text-slate-400 text-center">No transactions.</p>'; 
      },
      renderDashboard: () => App.renderAll(), // Alias
      renderFinance: () => App.renderTransactions(),
      renderWelfare: () => { /* Already loaded */ },
      renderPolls: () => { /* Already loaded */ },
      renderProfile: () => {
        // Fetch user details from backend if needed; placeholder
        document.getElementById('profile-name').value = App.data.user;
        document.getElementById('profile-email').value = App.data.user; // Use email from token in prod
      },
      toggleNotifications: () => {
        const panel = document.getElementById('notifications-panel');
        panel.classList.toggle('hidden');
      },
      renderNotifications: async () => {
        try {
          App.data.notifications = await App.fetchWithAuth('/notifications');
          const list = document.getElementById('notif-list');
          list.innerHTML = App.data.notifications.map(n => `<div class="p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition-colors" onclick="App.markRead(${n.id})">${n.message} <span class="text-xs text-slate-400 block mt-1">${new Date(n.createdAt || Date.now()).toLocaleString()}</span></div>`).join('');
          const unread = App.data.notifications.filter(n => !n.read).length;
          const badge = document.getElementById('notif-badge');
          badge.textContent = unread;
          badge.classList.toggle('hidden', unread === 0);
        } catch {}
      },
      markRead: async (id) => {
        await App.fetchWithAuth(`/notifications/${id}/read`, { method: 'PATCH' });
        App.renderNotifications();
      },
      uploadSlip: async () => { App.toast('Upload via M-Pesa USSD or bank app, then record manually.', 'info'); }, // Placeholder; add file upload if needed
      openLoanModal: () => document.getElementById('modal-loan').classList.remove('hidden'),
      submitLoan: async () => {
        const amount = document.getElementById('loan-amount').value;
        const purpose = document.getElementById('loan-purpose').value;
        if (!amount || !purpose) return App.toast('Fill all fields', 'error');
        App.showSpinner('loan-spinner');
        try {
          await App.fetchWithAuth('/loans', { method: 'POST', body: JSON.stringify({ amount, purpose, member: App.data.user }) });
          App.toast('Loan submitted!', 'success');
          document.getElementById('modal-loan').classList.add('hidden');
          document.getElementById('loan-amount').value = '';
          document.getElementById('loan-purpose').value = '';
          App.renderFinance();
        } catch {}
        finally { App.showSpinner('loan-spinner', false); }
      },
      openWelfareModal: () => document.getElementById('modal-welfare').classList.remove('hidden'),
      submitWelfare: async () => {
        const type = document.getElementById('welfare-type').value;
        const amount = document.getElementById('welfare-amount').value;
        if (!type || !amount) return App.toast('Fill all fields', 'error');
        App.showSpinner('welfare-spinner');
        try {
          await App.fetchWithAuth('/welfare', { method: 'POST', body: JSON.stringify({ type, amount, member: App.data.user }) });
          App.toast('Claim submitted!', 'success');
          document.getElementById('modal-welfare').classList.add('hidden');
          document.getElementById('welfare-amount').value = '';
          document.getElementById('welfare-type').value = '';
          App.renderWelfare();
        } catch {}
        finally { App.showSpinner('welfare-spinner', false); }
      },
      switchToAdmin: () => document.getElementById('modal-admin-pin').classList.remove('hidden'),
      verifyAdminPin: async () => {
        const pin = document.getElementById('admin-pin-input').value;
        if (pin.length !== 4) return App.toast('4-digit PIN required', 'error');
        App.showSpinner('admin-pin-spinner');
        try {
          const data = await App.fetchWithAuth('/auth/admin-pin', { method: 'POST', body: JSON.stringify({ pin }) }); // Assume backend endpoint
          userToken = data.token;
          localStorage.setItem('token', userToken);
          document.getElementById('modal-admin-pin').classList.add('hidden');
          document.getElementById('portal-member').classList.add('hidden');
          document.getElementById('portal-admin').classList.remove('hidden', 'opacity-0', 'scale-95');
          App.adminLogin(currentUserRole);
        } catch (err) {
          App.toast(err.message || 'Invalid PIN', 'error');
        } finally {
          App.showSpinner('admin-pin-spinner', false);
          document.getElementById('admin-pin-input').value = '';
        }
      },
      adminLogin: (role) => {
        document.querySelectorAll('[id^="view-admin-"]').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-admin-${role}`).classList.remove('hidden');
        const badge = document.getElementById('admin-badge');
        badge.textContent = 'Active';
        badge.className = 'text-[10px] bg-green-500/20 px-2 py-0.5 rounded text-green-400 ml-2 uppercase';
        badge.classList.remove('hidden');
        if (role === 'secretary') App.renderSecretaryDash();
        else if (role === 'treasurer') App.renderTreasurerDash();
        else if (role === 'chairperson') App.renderChairDash();
        else if (role === 'supervisorycommittee') App.renderSupervisoryDash();
        else if (role === 'committeemember') App.renderCommitteeDash();
      },
      adminLogout: () => {
        document.getElementById('portal-admin').classList.add('hidden', 'opacity-0', 'scale-95');
        document.getElementById('portal-member').classList.remove('hidden');
        const badge = document.getElementById('admin-badge');
        badge.textContent = 'Locked';
        badge.className = 'text-[10px] bg-white/10 px-2 py-0.5 rounded text-slate-400 ml-2 uppercase';
      },
      // Admin Methods (examples; expand as needed)
      createPoll: async () => {
        const question = document.getElementById('poll-question').value;
        const opts = document.getElementById('poll-opts').value.split(',').map(o => o.trim());
        if (!question || opts.length < 2) return App.toast('Valid question and 2+ options', 'error');
        App.showSpinner('poll-spinner');
        try {
          await App.fetchWithAuth('/polls', { method: 'POST', body: JSON.stringify({ question, options: opts }) });
          App.toast('Poll launched!', 'success');
          document.getElementById('poll-question').value = '';
          document.getElementById('poll-opts').value = '';
          App.renderPolls();
        } catch {}
        finally { App.showSpinner('poll-spinner', false); }
      },
      closePoll: async () => { /* Implement poll close endpoint */ App.toast('Poll closed', 'success'); },
      submitMinutes: async () => {
        const text = document.getElementById('minutes-text').value;
        if (!text) return App.toast('Enter minutes', 'error');
        App.showSpinner('minutes-spinner');
        try {
          await App.fetchWithAuth('/chair-queue', { method: 'POST', body: JSON.stringify({ type: 'Minutes', data: { text }, author: App.data.user }) });
          App.toast('Submitted to Chair', 'success');
          document.getElementById('minutes-text').value = '';
        } catch {}
        finally { App.showSpinner('minutes-spinner', false); }
      },
      handleDocUpload: async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64 = e.target.result.split(',')[1]; // Remove data URL prefix
          document.getElementById('doc-file-name').textContent = `Uploaded: ${file.name}`;
          await App.fetchWithAuth('/upload-docs', { method: 'POST', body: JSON.stringify({ fileName: file.name, fileData: base64, signedBy: App.data.user }) });
          App.toast('Document uploaded', 'success');
        };
        reader.readAsDataURL(file);
      },
      addMember: async () => {
        const name = document.getElementById('new-member-name').value.trim();
        const email = document.getElementById('new-member-email').value.trim();
        const pin = prompt('Set 4-digit PIN:'); // Simple; use modal in prod
        if (!name || !email || !pin || pin.length !== 4) return App.toast('Valid details', 'error');
        try {
          await App.fetchWithAuth('/members', { method: 'POST', body: JSON.stringify({ name, email, pin }) });
          App.toast('Member added', 'success');
          document.getElementById('new-member-name').value = '';
          document.getElementById('new-member-email').value = '';
          App.loadMembers();
        } catch {}
      },
      loadMembers: async () => { App.data.members = await App.fetchWithAuth('/members'); App.renderMembers(); },
      renderMembers: () => { 
        const list = document.getElementById('members-list');
        list.innerHTML = App.data.members.map(m => `<div class="p-3 bg-white/5 rounded-lg">${m.name} <span class="text-sm text-slate-400">(${m.role})</span></div>`).join('') || '<p class="text-slate-400 text-center">No members.</p>'; 
      },
      submitNews: async () => {
        const text = document.getElementById('sec-news').value;
        if (!text) return App.toast('Enter news', 'error');
        try {
          await App.fetchWithAuth('/news', { method: 'POST', body: JSON.stringify({ text, signed_by: App.data.user }) });
          App.toast('Submitted to Chair', 'success');
          document.getElementById('sec-news').value = '';
          App.loadNews();
        } catch {}
      },
      executeHandover: async (role) => {
        const name = document.getElementById(`handover-name-${role}`).value.trim();
        const sig = document.getElementById(`handover-sig-${role}`).value;
        if (!name || !sig) return App.toast('Name and signature required', 'error');
        try {
          await App.fetchWithAuth('/handover', { method: 'POST', body: JSON.stringify({ role, name, signature: sig }) });
          App.toast('Handover executed', 'success');
        } catch {}
      },
      renderSecretaryDash: async () => {
        await App.loadMembers();
        try {
          const welfare = await App.fetchWithAuth('/welfare?status=Pending');
          const queue = document.getElementById('sec-welfare-queue');
          queue.innerHTML = welfare.map(w => `<div class="p-3 bg-blue-900/20 rounded-lg">${w.member}: ${w.type} - KES ${w.amount.toLocaleString()}</div>`).join('') || '<p class="text-slate-400 text-center">No queue.</p>';
        } catch { App.toast('Load failed', 'error'); }
      },
      renderTreasurerDash: async () => {
        await App.renderPendingLoans();
        try {
          const welfare = await App.fetchWithAuth('/welfare?status=Pending');
          const queue = document.getElementById('treas-welfare-queue');
          queue.innerHTML = welfare.map(w => `<div class="p-3 bg-emerald-900/20 rounded-lg">${w.member}: KES ${w.amount.toLocaleString()}</div>`).join('') || '<p class="text-slate-400 text-center">No queue.</p>';
        } catch {}
      },
      renderPendingLoans: async () => {
        try {
          const loans = await App.fetchWithAuth('/loans?status=Pending');
          const list = document.getElementById('pending-loans');
          list.innerHTML = loans.map(l => `
            <div class="p-4 bg-white/5 rounded-lg flex justify-between items-center mb-2">
              <span class="text-sm">${l.member}: ${l.purpose} (KES ${l.amount.toLocaleString()})</span>
              <div class="flex gap-2">
                <button onclick="App.approveLoan(${l.id}, 'Approved')" class="bg-emerald-600 text-white px-3 py-1 rounded hover:bg-emerald-700"><span class="spinner hidden" id="loan-${l.id}-spinner"></span>Approve</button>
                <button onclick="App.approveLoan(${l.id}, 'Rejected')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Reject</button>
              </div>
            </div>
          `).join('') || '<p class="text-slate-400 text-center">No pending.</p>';
        } catch { App.toast('Load failed', 'error'); }
      },
      approveLoan: async (id, status) => {
        const spinner = document.getElementById(`loan-${id}-spinner`);
        spinner?.classList.remove('hidden');
        try {
          await App.fetchWithAuth(`/loans/${id}`, { method: 'PATCH', body: JSON.stringify({ status }) });
          App.toast(`${status} loan`, 'success');
          App.renderPendingLoans();
        } catch {}
        finally { spinner?.classList.add('hidden'); }
      },
      submitFinancialReport: async () => {
        const text = document.getElementById('treas-report').value;
        if (!text) return App.toast('Enter report', 'error');
        App.showSpinner('report-spinner');
        try {
          await App.fetchWithAuth('/approved-reports', { method: 'POST', body: JSON.stringify({ text, signedBy: App.data.user }) });
          App.toast('Submitted to Chair', 'success');
          document.getElementById('treas-report').value = '';
        } catch {}
        finally { App.showSpinner('report-spinner', false); }
      },
      renderChairDash: async () => {
        try {
          App.data.chairQueue = await App.fetchWithAuth('/chair-queue');
          const queue = document.getElementById('chair-queue');
          queue.innerHTML = App.data.chairQueue.map(q => `
            <div class="p-4 bg-purple-900/20 rounded-lg mb-2">
              <p class="mb-2">${q.type}: ${q.data?.text || q.data?.purpose || ''}</p>
              <button onclick="App.approveQueue('${q.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">Approve & Sign</button>
            </div>
          `).join('') || '<p class="text-slate-400 text-center">No queue.</p>';
        } catch { App.toast('Load failed', 'error'); }
      },
      approveQueue: async (id) => {
        const sig = prompt('Enter signature text:'); // Use select in prod
        if (!sig) return;
        try {
          await App.fetchWithAuth(`/chair-queue/${id}/approve`, { method: 'PATCH', body: JSON.stringify({ signature: sig }) });
          App.toast('Approved', 'success');
          App.renderChairDash();
        } catch {}
      },
      publishDirectComm: async () => {
        const text = document.getElementById('chair-comm').value;
        if (!text) return App.toast('Enter message', 'error');
        try {
          await App.fetchWithAuth('/news', { method: 'POST', body: JSON.stringify({ text, signed_by: App.data.user }) });
          App.toast('Published', 'success');
          document.getElementById('chair-comm').value = '';
          App.loadNews();
        } catch {}
      },
      promoteMember: async () => {
        const email = document.getElementById('promote-email').value;
        const role = document.getElementById('promote-role').value;
        if (!email || !role) return App.toast('Select email and role', 'error');
        App.showSpinner('promote-spinner');
        try {
          await App.fetchWithAuth(`/members/${email}/promote`, { method: 'POST', body: JSON.stringify({ role }) });
          App.toast('Promoted', 'success');
          document.getElementById('promote-email').value = '';
          document.getElementById('promote-role').value = '';
          App.loadMembers();
        } catch {}
        finally { App.showSpinner('promote-spinner', false); }
      },
      renderSupervisoryDash: async () => {
        try {
          App.data.logs = await App.fetchWithAuth('/logs');
          const logs = document.getElementById('supervisory-logs');
          logs.innerHTML = App.data.logs.map(l => `<div class="p-3 bg-white/5 rounded-lg"><span class="font-semibold">${l.action} by ${l.by}</span><span class="text-xs text-slate-400 block">${l.timestamp}</span></div>`).join('') || '<p class="text-slate-400 text-center">No logs.</p>';
        } catch { App.toast('Load failed', 'error'); }
      },
      downloadAuditReport: () => { /* Generate PDF or download logs */ App.toast('Report downloaded', 'success'); },
      renderCommitteeDash: async () => {
        // Load queues for notes
        await Promise.all([App.loadWelfare(), App.loadNews(), App.renderPendingLoans()]); // Reuse
        document.getElementById('cm-welfare-view').innerHTML = App.data.welfare.map(w => `<div class="p-2 bg-white/5 rounded">${w.member}: ${w.type}</div>`).join('') || '';
        document.getElementById('cm-news-view').innerHTML = App.data.news.slice(-3).map(n => `<div class="p-2 bg-white/5 rounded">${n.text.substring(0,50)}...</div>`).join('') || '';
        document.getElementById('cm-fin-report-view').innerHTML = App.data.loans.filter(l => l.status === 'Pending').map(l => `<div class="p-2 bg-white/5 rounded">${l.member}: KES ${l.amount}</div>`).join('') || '';
      },
      addCommitteeNote: async (type) => {
        const note = document.getElementById(`cm-${type}-note`).value;
        if (!note) return App.toast('Enter note', 'error');
        try {
          await App.fetchWithAuth('/chair-queue', { method: 'POST', body: JSON.stringify({ type: `${type} Note`, data: { note }, author: App.data.user }) });
          App.toast('Note added', 'success');
          document.getElementById(`cm-${type}-note`).value = '';
          App.renderCommitteeDash();
        } catch {}
      },
      downloadResults: () => { /* Export polls to PDF */ App.toast('Results downloaded', 'success'); },
      toggleEditProfile: () => {
        const inputs = document.querySelectorAll('#view-profile input:not(#new-pin)');
        inputs.forEach(input => input.disabled = !input.disabled);
        document.getElementById('save-profile-btn').classList.toggle('hidden');
        document.getElementById('edit-profile-btn').classList.toggle('hidden');
      },
      saveProfile: async () => {
        const name = document.getElementById('profile-name').value;
        const email = document.getElementById('profile-email').value;
        App.showSpinner('save-spinner');
        try {
          await App.fetchWithAuth(`/members/${email}`, { method: 'PUT', body: JSON.stringify({ name }) });
          App.toast('Profile saved', 'success');
          App.data.user = name;
          document.getElementById('welcome-user').textContent = `Welcome, ${name}`;
          App.toggleEditProfile(); // Re-disable
        } catch {}
        finally { App.showSpinner('save-spinner', false); }
      },
      changePin: async () => {
        const newPin = document.getElementById('new-pin').value;
        if (newPin.length !== 4) return App.toast('4 digits', 'error');
        App.showSpinner('pin-spinner');
        try {
          await App.fetchWithAuth(`/members/${App.data.user}`, { method: 'PUT', body: JSON.stringify({ newPin }) }); // Use email from token
          App.toast('PIN updated', 'success');
          document.getElementById('new-pin').value = '';
        } catch {}
        finally { App.showSpinner('pin-spinner', false); }
      },
      logout: () => {
        localStorage.removeItem('token');
        userToken = '';
        document.getElementById('portal-member').classList.add('hidden');
        document.getElementById('portal-admin').classList.add('hidden');
        document.getElementById('screen-auth').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
        document.getElementById('welcome-user').classList.add('hidden');
        document.getElementById('admin-badge').classList.add('hidden');
        deferredPrompt = null; // Reset install
        // Reset views
        App.nav('dashboard');
      },
      verifyPin: () => { /* For general PIN modals */ App.memberLogin(); } // Reuse
    };
    // Event Listeners
    document.addEventListener('keydown', (e) => { 
      if (e.key === 'Enter' && (document.activeElement.id.includes('pin') || document.activeElement.id.includes('login'))) App.memberLogin(); 
    });
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(() => {});
    window.onload = () => {
      const splash = document.getElementById('splash-screen');
      setTimeout(() => splash?.classList.add('opacity-0', 'pointer-events-none'), 1500);
      setTimeout(() => {
        splash?.classList.add('hidden');
        if (userToken) {
          // Auto-login if token (decode or fetch /auth/validate if needed)
          App.memberLogin(); // This will handle errors
        }
      }, 2200);
    };
  </script>
</body>
</html>
