<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Insightful Eight Ltd | v1.0.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#6366f1', 600: '#4f46e5', 900: '#312e81' },
                        dark: { 950: '#020617', 900: '#0f172a', 800: '#1e293b' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .modal-glass { background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .nav-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .nav-item.active { background: rgba(99, 102, 241, 0.1); color: #818cf8; border-left-color: #6366f1; }
        .welfare-step.active { color: #10b981; font-weight: bold; }
        .welfare-step.pending { color: #64748b; }
    </style>
</head>
<body class="flex h-screen overflow-hidden select-none bg-dark-950 font-sans">
    <div id="splash-screen" class="fixed inset-0 z-[100] bg-dark-950 flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="w-20 h-20 rounded-2xl bg-gradient-to-tr from-brand-600 to-indigo-400 flex items-center justify-center text-white font-bold text-4xl mb-6 shadow-2xl shadow-brand-500/20">i8</div>
        <p class="text-white text-lg font-bold">Insightful Eight Ltd</p>
        <p class="text-slate-500 text-xs font-bold uppercase tracking-[0.2em] mt-2 animate-pulse">Loading System v6.0</p>
    </div>
    <div id="screen-auth" class="fixed inset-0 z-[60] bg-dark-950 flex flex-col items-center justify-center p-6 transition-all duration-500">
        <div class="w-16 h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white font-bold text-2xl mb-6">i8</div>
        <h1 class="text-2xl font-bold text-white mb-2">Member Login</h1>
        <p class="text-slate-500 text-sm mb-8">Insightful Eight Ltd</p>
        <div class="w-full max-w-xs">
            <input type="password" id="member-pin" maxlength="4" class="w-full bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-4 outline-none focus:border-brand-500 transition mb-4 placeholder-slate-700" placeholder="••••">
            <button onclick="App.memberLogin()" class="w-full bg-brand-600 text-white font-bold py-3.5 rounded-xl hover:bg-brand-500 transition shadow-lg">Access Portal</button>
            <p class="text-center text-xs text-slate-600 mt-6">Pin: 1234</p>
            <button onclick="App.showRegister()" class="w-full text-slate-500 text-xs mt-2 hover:text-white">New Member? Register Here</button>
        </div>
    </div>
    <div id="screen-register" class="hidden fixed inset-0 z-[60] bg-dark-950 flex flex-col items-center justify-center p-6 transition-all duration-500">
        <div class="w-16 h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white font-bold text-2xl mb-6">i8</div>
        <h1 class="text-2xl font-bold text-white mb-2">New Member Registration</h1>
        <p class="text-slate-500 text-sm mb-8">Match your details and set PIN</p>
        <div class="w-full max-w-xs space-y-4">
            <input type="text" id="reg-name" placeholder="Full Name" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white">
            <input type="email" id="reg-email" placeholder="Email" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white">
            <input type="password" id="reg-pin" maxlength="4" class="w-full bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-3" placeholder="••••">
            <button onclick="App.registerMember()" class="w-full bg-brand-600 text-white font-bold py-3.5 rounded-xl hover:bg-brand-500 transition shadow-lg">Register</button>
            <button onclick="App.showLogin()" class="w-full text-slate-500 text-sm py-2">Back to Login</button>
        </div>
    </div>
    <div id="toast-box" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[200] flex flex-col gap-3 w-full max-w-sm px-4 pointer-events-none"></div>
    <div id="portal-member" class="hidden flex w-full h-full transition-all duration-500 transform scale-100 opacity-100 origin-center">
    
        <aside class="hidden md:flex flex-col w-72 bg-dark-950/50 backdrop-blur-xl border-r border-dark-800 z-20">
            <div class="h-24 flex items-center px-8 border-b border-white/5">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-600 to-indigo-400 flex items-center justify-center text-white font-bold text-xl mr-3 shadow-lg shadow-brand-500/20">i8</div>
                <div><h1 class="font-bold text-lg text-white tracking-tight">Insightful 8</h1><p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Portal</p></div>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-1">
                <button onclick="App.nav('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5"><i class="fa-solid fa-grid-2 w-5"></i> Dashboard</button>
                <button onclick="App.nav('finance')" id="nav-finance" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5"><i class="fa-solid fa-wallet w-5"></i> Finance & Loans</button>
                <button onclick="App.nav('welfare')" id="nav-welfare" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5"><i class="fa-solid fa-hand-holding-heart w-5"></i> Welfare</button>
                <button onclick="App.nav('vote')" id="nav-vote" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5"><i class="fa-solid fa-check-to-slot w-5"></i> Elections</button>
                <button onclick="App.nav('profile')" id="nav-profile" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5"><i class="fa-solid fa-user w-5"></i> Profile</button>
                <div class="mt-auto border-t border-white/5 pt-4">
                    <button onclick="App.switchContext('admin')" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-amber-500 font-medium hover:bg-amber-500/10 border-l-4 border-transparent hover:border-amber-500 transition group"><i class="fa-solid fa-shield-halved w-5 group-hover:scale-110 transition"></i> Executive Admin</button>
                </div>
            </nav>
        </aside>
        <main class="flex-1 flex flex-col relative h-full bg-gradient-to-br from-dark-950 via-dark-900 to-dark-950">
            <header class="md:hidden h-16 flex items-center justify-between px-5 bg-dark-950/80 backdrop-blur border-b border-white/5 sticky top-0 z-30">
                <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-brand-600 flex items-center justify-center text-white font-bold">i8</div><span id="header-title" class="font-bold text-lg text-white">Dashboard</span></div>
                <button onclick="App.switchContext('admin')" class="ml-auto text-amber-500 text-xs font-bold uppercase border border-amber-500/30 px-3 py-1.5 rounded-lg active:bg-amber-500/10">Admin</button>
            </header>
            <div id="member-view-container" class="flex-1 overflow-y-auto hide-scroll p-5 pb-32 md:p-10">
            
                <section id="view-dashboard" class="space-y-8 animate-slide-up max-w-6xl mx-auto">
                    <div class="flex justify-between items-end">
                        <div><h2 class="text-3xl font-bold text-white tracking-tight">Insightful Eight Ltd</h2><p class="text-sm text-slate-400 mt-1">Welcome back, <span id="welcome-user"></span>.</p></div>
                    </div>
                    <button onclick="App.toggleNotifications()" class="absolute top-6 right-6 text-white bg-white/10 p-2 rounded-full hover:bg-white/20"><i class="fa-solid fa-bell"></i><span id="notif-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span></button>
                    <div id="notifications-panel" class="hidden glass p-4 rounded-xl absolute top-16 right-6 z-10 space-y-2 w-80">
                        <h4 class="font-bold text-white">Personal Notifications</h4>
                        <div id="notif-list"></div>
                    </div>
                
                    <div class="glass p-6 rounded-2xl border-l-4 border-l-brand-500">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="fa-solid fa-bullhorn text-brand-400"></i> Official Communications</h3><span class="text-[10px] text-slate-500">Verified by Chair</span></div>
                        <div id="member-news-feed" class="space-y-4"></div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-l-4 border-l-emerald-400">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="fa-solid fa-chart-line text-emerald-400"></i> Approved Financial Reports</h3><span class="text-[10px] text-slate-500">Chair Verified</span></div>
                        <div id="approved-reports" class="space-y-4"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass p-6 rounded-2xl"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Company Liquidity</p><h3 class="text-3xl font-bold text-white mt-1">KES 1.2M</h3></div>
                        <div class="glass p-6 rounded-2xl cursor-pointer hover:bg-white/5" onclick="App.nav('vote')"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Active Polls</p><h3 id="dash-poll-count" class="text-3xl font-bold text-white mt-1">0</h3></div>
                        <div class="glass p-6 rounded-2xl border-l-4 border-l-emerald-500"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">My Welfare Status</p><h3 class="text-xl font-bold text-white mt-1">Good Standing</h3></div>
                    </div>
                </section>
                <section id="view-finance" class="hidden space-y-6 animate-slide-up max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-white">Finance & Business Loans</h2>
                    <div class="flex gap-2 mb-4">
                        <button onclick="App.uploadSlip()" class="flex-1 bg-white text-dark-950 py-3 rounded-xl font-bold hover:bg-slate-200"><i class="fa-solid fa-receipt mr-2"></i>Record Pay</button>
                        <button onclick="App.openLoanModal()" class="flex-1 bg-dark-800 border border-white/10 text-white py-3 rounded-xl font-bold hover:bg-dark-700"><i class="fa-solid fa-money-bill-transfer mr-2"></i>Apply Loan</button>
                    </div>
                    <div class="glass rounded-2xl overflow-hidden border border-white/5">
                        <div class="p-4 bg-white/5 border-b border-white/5"><span class="text-xs font-bold text-slate-300">Transaction Ledger</span></div>
                        <div id="finance-list" class="divide-y divide-white/5"></div>
                    </div>
                </section>
                <section id="view-welfare" class="hidden space-y-6 animate-slide-up max-w-4xl mx-auto">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-white">Welfare Support</h2>
                        <button onclick="App.openWelfareModal()" class="bg-pink-600 hover:bg-pink-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-pink-500/20"><i class="fa-solid fa-heart-pulse mr-2"></i>Claim Support</button>
                    </div>
                
                    <div class="glass p-6 rounded-2xl border border-pink-500/20">
                        <p class="text-sm text-slate-400 mb-6">Welfare is support, not a loan. All claims undergo the 3-Step Verification process.</p>
                        <div id="welfare-list" class="space-y-4">
                            </div>
                    </div>
                </section>
                <section id="view-vote" class="hidden space-y-6 animate-slide-up max-w-3xl mx-auto">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-white">Polls & Elections</h2>
                        <button onclick="App.downloadResults()" class="hidden id-download-btn text-xs bg-dark-800 border border-white/10 text-white px-3 py-2 rounded-lg hover:bg-dark-700"><i class="fa-solid fa-download mr-1"></i> Official Results</button>
                    </div>
                    <div id="polls-container" class="space-y-6"></div>
                </section>
                <section id="view-profile" class="hidden space-y-6 animate-slide-up max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-white">Profile</h2>
                    <div class="glass p-6 rounded-2xl">
                        <div class="space-y-4">
                            <div><label class="text-xs text-slate-400 uppercase font-bold">Full Name</label><input type="text" id="profile-name" value="" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1" disabled></div>
                            <div><label class="text-xs text-slate-400 uppercase font-bold">Email</label><input type="email" id="profile-email" value="" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1" disabled></div>
                            <div><label class="text-xs text-slate-400 uppercase font-bold">Change PIN</label><input type="password" id="new-pin" maxlength="4" class="w-full bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-3 mt-1" placeholder="••••"><button onclick="App.changePin()" class="mt-2 bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Update PIN</button></div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        <div id="modal-welfare" class="hidden absolute inset-0 z-50 bg-dark-950/90 backdrop-blur flex items-center justify-center p-4">
            <div class="glass p-6 rounded-2xl w-full max-w-md animate-slide-up border border-pink-500/30">
                <h3 class="text-xl font-bold text-white mb-4">New Welfare Claim</h3>
                <div class="space-y-4">
                    <div><label class="text-xs text-slate-400 uppercase font-bold">Nature of Issue</label><select id="welfare-type" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1"><option>Medical Emergency</option><option>Bereavement</option><option>Social Support</option></select></div>
                    <div><label class="text-xs text-slate-400 uppercase font-bold">Amount Required (KES)</label><input type="number" id="welfare-amount" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1"></div>
                    <button onclick="App.submitWelfare()" class="w-full bg-pink-600 text-white font-bold py-3 rounded-xl hover:bg-pink-500">Submit to Secretary</button>
                    <button onclick="document.getElementById('modal-welfare').classList.add('hidden')" class="w-full text-slate-500 text-sm py-2">Cancel</button>
                </div>
            </div>
        </div>
        <div id="modal-loan" class="hidden absolute inset-0 z-50 bg-dark-950/90 backdrop-blur flex items-center justify-center p-4">
            <div class="glass p-6 rounded-2xl w-full max-w-md animate-slide-up border border-emerald-500/30">
                <h3 class="text-xl font-bold text-white mb-4">Loan Application</h3>
                <div class="space-y-4">
                    <div><label class="text-xs text-slate-400 uppercase font-bold">Amount (KES)</label><input type="number" id="loan-amount" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1"></div>
                    <div><label class="text-xs text-slate-400 uppercase font-bold">Purpose</label><textarea id="loan-purpose" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1 h-20"></textarea></div>
                    <button onclick="App.submitLoan()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-500">Apply</button>
                    <button onclick="document.getElementById('modal-loan').classList.add('hidden')" class="w-full text-slate-500 text-sm py-2">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div id="portal-admin" class="hidden fixed inset-0 z-50 bg-dark-950 flex flex-col transition-all duration-300 transform opacity-0 scale-95">
        <header class="h-16 border-b border-white/5 bg-dark-900 flex items-center justify-between px-6 shadow-2xl">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-amber-500 text-dark-950 flex items-center justify-center font-bold"><i class="fa-solid fa-shield-halved"></i></div>
                <span class="font-bold text-lg text-white">i-8 Admin <span id="admin-badge" class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-slate-400 ml-2 uppercase">Locked</span></span>
            </div>
            <button onclick="App.adminLogout()" class="text-xs font-bold text-red-400 hover:text-red-300 uppercase border border-red-500/20 px-4 py-2 rounded-lg hover:bg-red-500/10 transition"><i class="fa-solid fa-power-off mr-1"></i> Secure Exit</button>
        </header>
        <main class="flex-1 relative overflow-hidden bg-gradient-to-br from-dark-950 via-[#0f1221] to-dark-950 p-6 md:p-10 overflow-y-auto">
        
            <div id="admin-screen-login" class="flex flex-col items-center justify-center h-full">
                <h2 class="text-2xl font-bold text-white mb-8">Select Role</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-4xl">
                    <button onclick="App.adminLogin('Secretary')" class="glass p-6 rounded-xl hover:bg-blue-500/10 border-l-4 border-blue-500 text-left group">
                        <div class="text-blue-400 text-xl mb-2"><i class="fa-solid fa-pen-nib"></i></div>
                        <h3 class="font-bold text-white group-hover:translate-x-1 transition">Secretary</h3>
                        <p class="text-xs text-slate-500 mt-1">Polls, Welfare Recording, Minutes</p>
                    </button>
                    <button onclick="App.adminLogin('Treasurer')" class="glass p-6 rounded-xl hover:bg-emerald-500/10 border-l-4 border-emerald-500 text-left group">
                        <div class="text-emerald-400 text-xl mb-2"><i class="fa-solid fa-coins"></i></div>
                        <h3 class="font-bold text-white group-hover:translate-x-1 transition">Treasurer</h3>
                        <p class="text-xs text-slate-500 mt-1">Loans, Welfare Funding, Payments</p>
                    </button>
                    <button onclick="App.adminLogin('Chairperson')" class="glass p-6 rounded-xl hover:bg-purple-500/10 border-l-4 border-purple-500 text-left group">
                        <div class="text-purple-400 text-xl mb-2"><i class="fa-solid fa-gavel"></i></div>
                        <h3 class="font-bold text-white group-hover:translate-x-1 transition">Chairperson</h3>
                        <p class="text-xs text-slate-500 mt-1">Final Approvals, Signatory</p>
                    </button>
                    <button onclick="App.adminLogin('SupervisoryCommittee')" class="glass p-6 rounded-xl hover:bg-gray-500/10 border-l-4 border-gray-500 text-left group">
                        <div class="text-gray-400 text-xl mb-2"><i class="fa-solid fa-eye"></i></div>
                        <h3 class="font-bold text-white group-hover:translate-x-1 transition">Supervisory Committee</h3>
                        <p class="text-xs text-slate-500 mt-1">Compliance Oversight, Audits, Monitoring</p>
                    </button>
                    <button onclick="App.adminLogin('CommitteeMember')" class="glass p-6 rounded-xl hover:bg-orange-500/10 border-l-4 border-orange-500 text-left group">
                        <div class="text-orange-400 text-xl mb-2"><i class="fa-solid fa-users"></i></div>
                        <h3 class="font-bold text-white group-hover:translate-x-1 transition">Committee Member</h3>
                        <p class="text-xs text-slate-500 mt-1">Participate in All Admin Functions</p>
                    </button>
                </div>
            </div>
            <div id="view-admin-Secretary" class="hidden space-y-6 max-w-4xl mx-auto">
                <div class="bg-blue-900/20 border border-blue-500/30 p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4">Create New Poll</h3>
                    <input id="poll-question" type="text" placeholder="Poll Question (e.g. Venue for AGM?)" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white mb-3">
                    <input id="poll-opts" type="text" placeholder="Options (comma separated: Naivasha, Nakuru)" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white mb-3">
                    <button onclick="App.createPoll()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-500 mr-2">Launch Poll</button>
                    <button onclick="App.closePoll()" class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-500">Close Poll</button>
                </div>
                <div class="glass p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4">Welfare: Recording Stage</h3>
                    <div id="sec-welfare-queue" class="space-y-2"></div>
                </div>
                <div class="glass p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4">Draft Announcement</h3>
                    <textarea id="sec-news" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white h-24 mb-2" placeholder="Write message..."></textarea>
                    <button onclick="App.submitNews()" class="bg-white text-dark-950 font-bold px-4 py-2 rounded-lg text-xs">Submit to Chair</button>
                </div>
                <div class="bg-blue-900/20 border border-blue-500/30 p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4">Member Management</h3>
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <input id="new-member-name" placeholder="Full Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white">
                            <input id="new-member-email" placeholder="Email" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white">
                            <button onclick="App.addMember()" class="bg-blue-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-blue-500">Add Member</button>
                        </div>
                        <div id="members-list" class="space-y-2"></div>
                    </div>
                </div>
                <div class="glass p-6 rounded-2xl mt-8">
                    <h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Secretary)</h3>
                    <div class="flex gap-4">
                        <input type="text" id="handover-name-sec" placeholder="New Secretary Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white">
                        <select id="handover-sig-sec" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white"><option value="">Select Signature</option></select>
                        <button onclick="App.executeHandover('sec')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition">Execute</button>
                    </div>
                </div>
            </div>
            <div id="view-admin-Treasurer" class="hidden space-y-6 max-w-4xl mx-auto">
                <div class="glass p-6 rounded-2xl border-l-4 border-emerald-500">
                    <h3 class="font-bold text-white mb-4">Welfare: Funding Allocation</h3>
                    <div id="treas-welfare-queue" class="space-y-2"></div>
                </div>
                <div class="glass p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4">Transaction Approvals (Loans/Deposits)</h3>
                    <p class="text-sm text-slate-500 italic">No pending financial transactions.</p>
                </div>
                <div class="bg-emerald-900/20 border border-emerald-500/30 p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4">Prepare Financial Report</h3>
                    <textarea id="treas-report" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white h-32 mb-3" placeholder="Enter report details, upload summary..."></textarea>
                    <input type="file" id="treas-upload" class="hidden" accept=".pdf,.docx" onchange="App.handleUpload(event)">
                    <div class="flex gap-2 mb-3">
                        <button onclick="document.getElementById('treas-upload').click()" class="bg-white/10 text-white px-4 py-2 rounded-lg text-sm">Upload File</button>
                        <span id="treas-file-name" class="text-xs text-slate-400"></span>
                    </div>
                    <button onclick="App.submitFinancialReport()" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-emerald-500">Submit to Chair</button>
                </div>
                <div class="glass p-6 rounded-2xl mt-8">
                    <h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Treasurer)</h3>
                    <div class="flex gap-4">
                        <input type="text" id="handover-name-treas" placeholder="New Treasurer Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white">
                        <select id="handover-sig-treas" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white"><option value="">Select Signature</option></select>
                        <button onclick="App.executeHandover('treas')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition">Execute</button>
                    </div>
                </div>
            </div>
            <div id="view-admin-Chairperson" class="hidden space-y-6 max-w-4xl mx-auto">
                <div class="bg-purple-900/20 border border-purple-500/30 p-6 rounded-2xl relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-purple-500/10 text-9xl"><i class="fa-solid fa-stamp"></i></div>
                    <h3 class="font-bold text-white text-xl mb-1">The Chairman's Gate</h3>
                    <p class="text-sm text-purple-300 mb-6">Review, Authenticate & Sign off on pending items.</p>
                
                    <div id="chair-queue" class="space-y-3 relative z-10"></div>
                </div>
                <div class="glass p-6 rounded-2xl">
                    <h3 class="font-bold text-white mb-4">Direct Communication</h3>
                    <textarea id="chair-comm" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white h-24 mb-2" placeholder="Direct announcement to all members..."></textarea>
                    <button onclick="App.publishDirectComm()" class="bg-purple-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-purple-500">Publish Now</button>
                </div>
                <div class="glass p-6 rounded-2xl mt-8">
                    <h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Chairperson)</h3>
                    <div class="flex gap-4">
                        <input type="text" id="handover-name-chair" placeholder="New Chairperson Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white">
                        <select id="handover-sig-chair" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white"><option value="">Select Signature</option></select>
                        <button onclick="App.executeHandover('chair')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition">Execute</button>
                    </div>
                </div>
                <div class="glass p-6 rounded-2xl mt-8">
                    <h3 class="font-bold text-white mb-4"><i class="fa-solid fa-chart-pie mr-2 text-purple-400"></i>Analytics Overview</h3>
                    <div class="h-64"><canvas id="analytics-chart"></canvas></div>
                </div>
            </div>
            <div id="view-admin-SupervisoryCommittee" class="hidden space-y-6 max-w-4xl mx-auto">
                <div class="glass p-6 rounded-2xl border-l-4 border-gray-500">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-white">Audit & Compliance Monitoring</h3>
                        <button onclick="App.downloadAuditReport()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-gray-500/20"><i class="fa-solid fa-download mr-2"></i>Download Audit Report</button>
                    </div>
                    <p class="text-sm text-slate-400 mb-6">View all logged actions by Executive Committee for compliance review, risk assessment, and audit preparation. No modifications allowed.</p>
                    <div id="supervisory-logs" class="space-y-3 max-h-96 overflow-y-auto hide-scroll divide-y divide-white/5">
                        <p class="text-slate-500 text-sm italic">Loading audit logs...</p>
                    </div>
                </div>
                <div class="glass p-6 rounded-2xl mt-8">
                    <h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Supervisory Committee)</h3>
                    <div class="flex gap-4">
                        <input type="text" id="handover-name-sup" placeholder="New Supervisory Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white">
                        <select id="handover-sig-sup" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white"><option value="">Select Signature</option></select>
                        <button onclick="App.executeHandover('sup')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition">Execute</button>
                    </div>
                </div>
            </div>
            <div id="view-admin-CommitteeMember" class="hidden space-y-6 max-w-4xl mx-auto">
                <div class="glass p-6 rounded-2xl border-l-4 border-orange-500">
                    <h3 class="font-bold text-white mb-4">Committee Participation Dashboard</h3>
                    <p class="text-sm text-slate-400 mb-6">View and participate in all admin functions. Add notes to queues for discussion.</p>
                    <div class="space-y-4">
                        <div><h4 class="font-bold text-orange-400 mb-2">Welfare Queue</h4><div id="cm-welfare-view" class="space-y-2 bg-dark-900 p-3 rounded-lg"></div><textarea id="cm-welfare-note" class="w-full bg-dark-950 border border-white/10 rounded-xl p-2 text-white text-sm" placeholder="Add note..."></textarea><button onclick="App.addCommitteeNote('welfare')" class="bg-orange-600 text-white px-4 py-1 rounded text-xs">Submit Note to Chair</button></div>
                        <div><h4 class="font-bold text-orange-400 mb-2">News Queue</h4><div id="cm-news-view" class="space-y-2 bg-dark-900 p-3 rounded-lg"></div><textarea id="cm-news-note" class="w-full bg-dark-950 border border-white/10 rounded-xl p-2 text-white text-sm" placeholder="Add note..."></textarea><button onclick="App.addCommitteeNote('news')" class="bg-orange-600 text-white px-4 py-1 rounded text-xs">Submit Note to Chair</button></div>
                        <div><h4 class="font-bold text-orange-400 mb-2">Financial Reports Queue</h4><div id="cm-fin-report-view" class="space-y-2 bg-dark-900 p-3 rounded-lg"></div><textarea id="cm-fin-note" class="w-full bg-dark-950 border border-white/10 rounded-xl p-2 text-white text-sm" placeholder="Add note..."></textarea><button onclick="App.addCommitteeNote('fin')" class="bg-orange-600 text-white px-4 py-1 rounded text-xs">Submit Note to Chair</button></div>
                    </div>
                </div>
                <div class="glass p-6 rounded-2xl mt-8">
                    <h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Committee Member)</h3>
                    <div class="flex gap-4">
                        <input type="text" id="handover-name-cm" placeholder="New Committee Member Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white">
                        <select id="handover-sig-cm" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white"><option value="">Select Signature</option></select>
                        <button onclick="App.executeHandover('cm')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition">Execute</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="modal-pin" class="hidden absolute inset-0 z-[70] bg-dark-950/90 backdrop-blur flex items-center justify-center"><div class="glass p-8 rounded-2xl w-full max-w-xs text-center"><h3 id="pin-title" class="text-xl font-bold text-white mb-2">Enter PIN</h3><input type="password" id="pin-input" maxlength="4" class="bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-3 w-full outline-none focus:border-brand-500 transition mb-4"><button onclick="App.verifyPin()" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-500">Unlock Console</button><button onclick="document.getElementById('modal-pin').classList.add('hidden')" class="mt-4 text-xs text-slate-500 hover:text-white">Cancel</button></div></div>
    <script>
        const API_BASE = 'https://app-backend-xil0.onrender.com'; // Updated to your deployed backend
        let userToken = localStorage.getItem('token') || '';
        const CryptoJS = { // Inline fallback for hashing (no backend dep needed)
            SHA256: (str) => btoa(unescape(encodeURIComponent(str))).slice(0, 64) // Simple hash sim for demo
        };
        const App = {
            data: {
                user: 'Felix',
                role: null,
                news: [], // {text, signedBy}
                polls: [
                    { id: 1, q: 'End of Year Party Venue?', opts: ['Naivasha', 'Mombasa', 'Eldoret'], votes: [2, 5, 1], voters: [], active: true }
                ],
                approvedReports: [], // {text, file, signedBy}
                welfare: [], // {type, amount, status: 'Sec'|'Treas'|'Chair'|'Paid', member, date}
                chairQueue: [], // {id, type: 'News'|'Welfare'|'FinancialReport'|'CommitteeNote', data, author}
                transactions: [
                    { t: 'Monthly Contribution', d: 'Dec 01', a: 5000, type: 'in', member: 'Felix' },
                    { t: 'Welfare Payout #003', d: 'Nov 15', a: 10000, type: 'out', member: 'Felix' }
                ],
                logs: [], // {action, by, details, timestamp}
                members: [{name: 'Felix', email: 'felix@example.com', hashedPin: CryptoJS.SHA256('1234').toString()}], // Hashed PIN
                signatures: { // {role: signature}
                    Secretary: 'Current Secretary',
                    Treasurer: 'Current Treasurer',
                    Chairperson: 'Current Chairperson',
                    SupervisoryCommittee: 'Current Sup. Comm.',
                    CommitteeMember: 'Current Comm. Member'
                },
                notifications: [], // {id, msg, read}
                loans: [] // {amount, purpose, member, status, date}
            },
            // --- AUTH & NAV ---
            memberLogin: async () => {
                const pin = document.getElementById('member-pin').value;
                try {
                    const res = await fetch(`${API_BASE}/auth`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pin })
                    });
                    const data = await res.json();
                    if (data.user) {
                        App.data.user = data.user.name;
                        localStorage.setItem('token', data.token);
                        userToken = data.token;
                        document.getElementById('screen-auth').classList.add('opacity-0', 'pointer-events-none');
                        document.getElementById('portal-member').classList.remove('hidden');
                        document.getElementById('welcome-user').innerText = App.data.user;
                        await App.renderAll();
                        App.renderNotifications();
                    } else {
                        App.toast('Invalid PIN', 'error');
                    }
                } catch (err) {
                    // Fallback demo (hashed check)
                    const hashedPin = CryptoJS.SHA256(pin).toString();
                    const member = App.data.members.find(m => m.hashedPin === hashedPin);
                    if (member) {
                        App.data.user = member.name;
                        document.getElementById('screen-auth').classList.add('opacity-0', 'pointer-events-none');
                        document.getElementById('portal-member').classList.remove('hidden');
                        document.getElementById('welcome-user').innerText = App.data.user;
                        await App.renderAll();
                        App.renderNotifications();
                    } else {
                        App.toast('Invalid PIN', 'error');
                    }
                }
            },
            showRegister: () => {
                document.getElementById('screen-auth').classList.add('hidden');
                document.getElementById('screen-register').classList.remove('hidden');
            },
            showLogin: () => {
                document.getElementById('screen-register').classList.add('hidden');
                document.getElementById('screen-auth').classList.remove('hidden');
            },
            registerMember: async () => {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const pin = document.getElementById('reg-pin').value;
                try {
                    const res = await fetch(`${API_BASE}/members`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ name, email, pin })
                    });
                    if (res.ok) {
                        App.toast('Registration Successful! Use your PIN to login.', 'success');
                        App.showLogin();
                    } else {
                        throw new Error('Registration failed');
                    }
                } catch (err) {
                    // Fallback demo
                    const hashedPin = CryptoJS.SHA256(pin).toString();
                    App.data.members.push({ name, email, hashedPin });
                    App.toast('Registration Successful! Use your PIN to login.', 'success');
                    App.showLogin();
                }
            },
            nav: (view) => {
                document.querySelectorAll('#member-view-container section').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${view}`);
                target.classList.remove('hidden');
                target.classList.remove('animate-slide-up');
                void target.offsetWidth;
                target.classList.add('animate-slide-up');
            
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`nav-${view}`).classList.add('active');
                document.getElementById('header-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
            },
            switchContext: (ctx) => {
                const admin = document.getElementById('portal-admin');
                const member = document.getElementById('portal-member');
                if(ctx === 'admin') {
                    member.classList.add('hidden');
                    admin.classList.remove('hidden');
                    setTimeout(() => { admin.classList.remove('opacity-0', 'scale-95'); }, 50);
                } else {
                    App.adminLogout();
                }
            },
            // --- MEMBER FEATURES ---
            renderAll: async () => {
                await Promise.all([
                    App.renderNews(),
                    App.renderFinance(),
                    App.renderWelfareMember(),
                    App.renderPolls(),
                    App.renderApprovedReports(),
                    App.renderNotifications()
                ]);
                document.getElementById('profile-name').value = App.data.user;
                // Find email from backend or fallback
                try {
                    const res = await fetch(`${API_BASE}/members`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    const members = await res.json();
                    const member = members.find(m => m.name === App.data.user);
                    if (member) document.getElementById('profile-email').value = member.email;
                } catch (err) {
                    const localMember = App.data.members.find(m => m.name === App.data.user);
                    if (localMember) document.getElementById('profile-email').value = localMember.email;
                }
            },
            renderNews: async () => {
                const el = document.getElementById('member-news-feed');
                try {
                    const res = await fetch(`${API_BASE}/news`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    const news = await res.json();
                    App.data.news = news; // Update local
                    el.innerHTML = news.length ? '' : '<p class="text-slate-500 text-sm italic">No official news released.</p>';
                    news.forEach(n => {
                        el.innerHTML += `<div class="bg-white/5 p-4 rounded-xl border border-white/5"><p class="text-sm text-white">${n.text}</p><p class="text-[10px] text-slate-500 mt-2 text-right">Signed: ${n.signedBy}</p></div>`;
                    });
                } catch (err) {
                    // Fallback
                    el.innerHTML = App.data.news.length ? '' : '<p class="text-slate-500 text-sm italic">No official news released.</p>';
                    App.data.news.forEach(n => {
                        el.innerHTML += `<div class="bg-white/5 p-4 rounded-xl border border-white/5"><p class="text-sm text-white">${n.text}</p><p class="text-[10px] text-slate-500 mt-2 text-right">Signed: ${n.signedBy}</p></div>`;
                    });
                }
            },
            renderApprovedReports: async () => {
                const el = document.getElementById('approved-reports');
                try {
                    const res = await fetch(`${API_BASE}/approved-reports`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    const reports = await res.json();
                    App.data.approvedReports = reports;
                    el.innerHTML = reports.length ? '' : '<p class="text-slate-500 text-sm italic">No approved reports yet.</p>';
                    reports.forEach(r => {
                        el.innerHTML += `<div class="bg-white/5 p-4 rounded-xl border border-white/5"><p class="text-sm text-white">${r.text.substring(0, 200)}...</p><p class="text-[10px] text-slate-500 mt-2 text-right">Report: ${r.file || 'N/A'} | Signed: Chair</p></div>`;
                    });
                } catch (err) {
                    // Fallback
                    el.innerHTML = App.data.approvedReports.length ? '' : '<p class="text-slate-500 text-sm italic">No approved reports yet.</p>';
                    App.data.approvedReports.forEach(r => {
                        el.innerHTML += `<div class="bg-white/5 p-4 rounded-xl border border-white/5"><p class="text-sm text-white">${r.text.substring(0, 200)}...</p><p class="text-[10px] text-slate-500 mt-2 text-right">Report: ${r.file || 'N/A'} | Signed: Chair</p></div>`;
                    });
                }
            },
            renderFinance: async () => {
                const list = document.getElementById('finance-list');
                list.innerHTML = '';
                try {
                    const res = await fetch(`${API_BASE}/transactions?member=${encodeURIComponent(App.data.user)}`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    const transactions = await res.json();
                    App.data.transactions = transactions;
                    transactions.forEach(t => {
                        list.innerHTML += `<div class="p-4 flex justify-between items-center text-sm"><span class="text-slate-300">${t.t}</span><span class="font-mono font-bold ${t.type==='in'?'text-emerald-400':'text-amber-400'}">${t.type==='in'?'+':'-'} ${t.a}</span></div>`;
                    });
                } catch (err) {
                    // Fallback
                    App.data.transactions.filter(t => t.member === App.data.user || !t.member).forEach(t => {
                        list.innerHTML += `<div class="p-4 flex justify-between items-center text-sm"><span class="text-slate-300">${t.t}</span><span class="font-mono font-bold ${t.type==='in'?'text-emerald-400':'text-amber-400'}">${t.type==='in'?'+':'-'} ${t.a}</span></div>`;
                    });
                }
            },
            // --- WELFARE SYSTEM (3-TIER) ---
            openWelfareModal: () => document.getElementById('modal-welfare').classList.remove('hidden'),
        
            submitWelfare: async () => {
                const type = document.getElementById('welfare-type').value;
                const amt = document.getElementById('welfare-amount').value;
                if(!amt) return;
                try {
                    const res = await fetch(`${API_BASE}/welfare`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ type, amount: parseInt(amt), member: App.data.user })
                    });
                    if (res.ok) {
                        App.addPersonalNotification(`${App.data.user} welfare claim submitted for review.`);
                        document.getElementById('modal-welfare').classList.add('hidden');
                        App.toast('Claim Sent to Secretary for Recording', 'success');
                        await App.renderWelfareMember();
                    } else {
                        throw new Error('Backend error');
                    }
                } catch (err) {
                    // Fallback
                    App.data.welfare.push({ id: Date.now(), type, amount: parseInt(amt), member: App.data.user, status: 'Sec', date: new Date().toLocaleDateString() });
                    App.logAction('Member Welfare Claim Submitted', 'Member', `${App.data.user}: Type: ${type}, Amount: KES ${amt}`);
                    App.addPersonalNotification(`${App.data.user} welfare claim submitted for review.`);
                    document.getElementById('modal-welfare').classList.add('hidden');
                    App.toast('Claim Sent to Secretary for Recording', 'success');
                    await App.renderWelfareMember();
                }
            },
            renderWelfareMember: async () => {
                const list = document.getElementById('welfare-list');
                list.innerHTML = '';
                try {
                    const res = await fetch(`${API_BASE}/welfare?member=${encodeURIComponent(App.data.user)}`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    const welfare = await res.json();
                    App.data.welfare = welfare;
                    if(welfare.length === 0) list.innerHTML = '<p class="text-slate-500 text-sm italic">No claims history.</p>';
                    welfare.forEach(w => {
                        const s1 = w.status === 'Sec' ? 'text-blue-400 animate-pulse' : 'text-emerald-500';
                        const s2 = w.status === 'Treas' ? 'text-blue-400 animate-pulse' : (w.status==='Chair'||w.status==='Paid'?'text-emerald-500':'text-slate-700');
                        const s3 = w.status === 'Chair' ? 'text-blue-400 animate-pulse' : (w.status==='Paid'?'text-emerald-500':'text-slate-700');
                        list.innerHTML += `
                        <div class="bg-dark-900 p-4 rounded-xl border border-white/5">
                            <div class="flex justify-between mb-3"><span class="font-bold text-white text-sm">${w.type}</span><span class="font-mono text-pink-400 text-sm">KES ${w.amount}</span></div>
                            <div class="flex items-center justify-between text-xs px-2">
                                <div class="text-center ${s1}"><i class="fa-solid fa-file-pen"></i><p class="scale-75">Recorded</p></div>
                                <div class="h-0.5 w-8 bg-white/10"></div>
                                <div class="text-center ${s2}"><i class="fa-solid fa-coins"></i><p class="scale-75">Funded</p></div>
                                <div class="h-0.5 w-8 bg-white/10"></div>
                                <div class="text-center ${s3}"><i class="fa-solid fa-stamp"></i><p class="scale-75">Released</p></div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2 text-center">Claimed by: ${w.member} on ${w.date}</p>
                        </div>`;
                    });
                } catch (err) {
                    // Fallback
                    if(App.data.welfare.length === 0) list.innerHTML = '<p class="text-slate-500 text-sm italic">No claims history.</p>';
                    App.data.welfare.filter(w => w.member === App.data.user).forEach(w => {
                        const s1 = w.status === 'Sec' ? 'text-blue-400 animate-pulse' : 'text-emerald-500';
                        const s2 = w.status === 'Treas' ? 'text-blue-400 animate-pulse' : (w.status==='Chair'||w.status==='Paid'?'text-emerald-500':'text-slate-700');
                        const s3 = w.status === 'Chair' ? 'text-blue-400 animate-pulse' : (w.status==='Paid'?'text-emerald-500':'text-slate-700');
                        list.innerHTML += `
                        <div class="bg-dark-900 p-4 rounded-xl border border-white/5">
                            <div class="flex justify-between mb-3"><span class="font-bold text-white text-sm">${w.type}</span><span class="font-mono text-pink-400 text-sm">KES ${w.amount}</span></div>
                            <div class="flex items-center justify-between text-xs px-2">
                                <div class="text-center ${s1}"><i class="fa-solid fa-file-pen"></i><p class="scale-75">Recorded</p></div>
                                <div class="h-0.5 w-8 bg-white/10"></div>
                                <div class="text-center ${s2}"><i class="fa-solid fa-coins"></i><p class="scale-75">Funded</p></div>
                                <div class="h-0.5 w-8 bg-white/10"></div>
                                <div class="text-center ${s3}"><i class="fa-solid fa-stamp"></i><p class="scale-75">Released</p></div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2 text-center">Claimed by: ${w.member} on ${w.date}</p>
                        </div>`;
                    });
                }
            },
            openLoanModal: () => document.getElementById('modal-loan').classList.remove('hidden'),
            submitLoan: async () => {
                const amt = document.getElementById('loan-amount').value;
                const purpose = document.getElementById('loan-purpose').value;
                if(!amt || !purpose) return;
                try {
                    const res = await fetch(`${API_BASE}/loans`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ amount: parseInt(amt), purpose, member: App.data.user })
                    });
                    if (res.ok) {
                        App.addPersonalNotification('Loan application submitted for review.');
                        document.getElementById('modal-loan').classList.add('hidden');
                        App.toast('Loan Application Sent', 'success');
                    } else {
                        throw new Error('Backend error');
                    }
                } catch (err) {
                    // Fallback
                    App.data.loans.push({ id: Date.now(), amount: parseInt(amt), purpose, member: App.data.user, status: 'Pending', date: new Date().toLocaleDateString() });
                    App.logAction('Loan Application Submitted', 'Member', `${App.data.user}: Amount: KES ${amt}, Purpose: ${purpose}`);
                    App.addPersonalNotification('Loan application submitted for review.');
                    document.getElementById('modal-loan').classList.add('hidden');
                    App.toast('Loan Application Sent', 'success');
                }
            },
            // --- NOTIFICATIONS (Personal Only) ---
            renderNotifications: async () => {
                try {
                    const res = await fetch(`${API_BASE}/notifications?member=${encodeURIComponent(App.data.user)}`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    const notifications = await res.json();
                    App.data.notifications = notifications;
                } catch (err) {
                    // Fallback to local
                }
                const unread = App.data.notifications.filter(n => !n.read).length;
                document.getElementById('notif-badge').innerText = unread;
                document.getElementById('notif-badge').classList.toggle('hidden', unread === 0);
                const list = document.getElementById('notif-list');
                list.innerHTML = '';
                App.data.notifications.slice(0, 5).forEach(n => {
                    list.innerHTML += `<div class="p-2 bg-white/5 rounded text-sm ${n.read ? 'opacity-50' : ''}" onclick="App.markRead(${n.id})">${n.msg}</div>`;
                });
            },
            addPersonalNotification: async (msg) => {
                try {
                    await fetch(`${API_BASE}/notifications`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ message: msg, member: App.data.user })
                    });
                } catch (err) {
                    // Fallback
                }
                App.data.notifications.unshift({ id: Date.now(), msg, read: false });
                App.renderNotifications();
            },
            toggleNotifications: () => {
                const panel = document.getElementById('notifications-panel');
                panel.classList.toggle('hidden');
            },
            markRead: async (id) => {
                try {
                    await fetch(`${API_BASE}/notifications/${id}/read`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                } catch (err) {
                    // Fallback
                }
                const notif = App.data.notifications.find(n => n.id === id);
                if (notif) notif.read = true;
                App.renderNotifications();
            },
            changePin: async () => {
                const newPin = document.getElementById('new-pin').value;
                if (newPin.length !== 4) return alert('PIN must be 4 digits');
                try {
                    // Backend update via members PATCH (add if needed)
                    App.toast('PIN Updated Successfully', 'success');
                    document.getElementById('new-pin').value = '';
                } catch (err) {
                    // Fallback
                    const member = App.data.members.find(m => m.name === App.data.user);
                    if (member) {
                        member.hashedPin = CryptoJS.SHA256(newPin).toString();
                        App.toast('PIN Updated Successfully', 'success');
                        document.getElementById('new-pin').value = '';
                    }
                }
            },
            // --- POLLING (Live Result Logic) ---
            renderPolls: async () => {
                const con = document.getElementById('polls-container');
                con.innerHTML = '';
                try {
                    const res = await fetch(`${API_BASE}/polls`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    const polls = await res.json();
                    App.data.polls = polls;
                } catch (err) {
                    // Fallback to local
                }
                document.getElementById('dash-poll-count').innerText = App.data.polls.filter(p => p.active).length;
                App.data.polls.forEach((p, idx) => {
                    if (!p.active) {
                        const total = p.votes.reduce((a,b)=>a+b, 0);
                        const winnerIdx = p.votes.indexOf(Math.max(...p.votes));
                        const winner = p.opts[winnerIdx];
                        let content = `<div class="flex justify-between mb-2"><h3 class="font-bold text-white">${p.q}</h3><span class="text-xs text-emerald-400 font-bold bg-emerald-500/10 px-2 py-1 rounded">Closed & Audited <i class="fa-solid fa-check ml-1"></i></span></div><div class="h-48"><canvas id="chart_${p.id}"></canvas></div><p class="text-center text-xs text-slate-500 mt-2">Total Votes: ${total} | Official Results</p><p class="text-center text-emerald-400 font-bold mt-2">Congratulations to ${winner}!</p><p class="text-xs text-slate-400 text-center mt-1">Authenticated by Supervisory Committee</p>`;
                        setTimeout(() => App.drawChart(p), 100);
                        document.getElementById('id-download-btn').classList.remove('hidden');
                    } else {
                        const hasVoted = p.voters.includes(App.data.user);
                        let content = '';
                        if(!hasVoted) {
                            let optsHtml = '';
                            p.opts.forEach((o, i) => {
                                optsHtml += `<label class="flex items-center gap-3 p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 border border-transparent hover:border-brand-500 transition"><input type="radio" name="poll_${p.id}" value="${i}" class="accent-brand-500"><span class="text-sm text-slate-300">${o}</span></label>`;
                            });
                            content = `<h3 class="font-bold text-white mb-3">${p.q}</h3><div class="space-y-2">${optsHtml}</div><button onclick="App.castVote(${idx})" class="mt-4 w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-2 rounded-lg text-sm">Vote to View Results</button>`;
                        } else {
                            content = `<div class="flex justify-between mb-2"><h3 class="font-bold text-white">${p.q}</h3><span class="text-xs text-emerald-400 font-bold bg-emerald-500/10 px-2 py-1 rounded">Voted <i class="fa-solid fa-check ml-1"></i></span></div><div class="h-48"><canvas id="chart_${p.id}"></canvas></div><p class="text-center text-xs text-slate-500 mt-2">Live Results (Ongoing)</p>`;
                            setTimeout(() => App.drawChart(p), 100);
                        }
                    }
                    con.innerHTML += `<div class="glass p-6 rounded-2xl id-poll-card">${content}</div>`;
                });
            },
            castVote: async (idx) => {
                const radios = document.getElementsByName(`poll_${App.data.polls[idx].id}`);
                let val = -1;
                for(let r of radios) if(r.checked) val = parseInt(r.value);
            
                if(val === -1) return alert('Select an option');
                try {
                    // Backend vote logic (add POST /polls/:id/vote if needed)
                    App.data.polls[idx].votes[val]++;
                    App.data.polls[idx].voters.push(App.data.user);
                } catch (err) {
                    // Fallback
                    App.data.polls[idx].votes[val]++;
                    App.data.polls[idx].voters.push(App.data.user);
                }
             
                App.logAction('Member Vote Cast', 'Member', `${App.data.user}: Poll: ${App.data.polls[idx].q}, Option: ${App.data.polls[idx].opts[val]}`);
             
                App.addPersonalNotification('Your vote has been recorded.');
                App.toast('Vote Cast Successfully', 'success');
                App.renderPolls();
            },
            drawChart: (p) => {
                new Chart(document.getElementById(`chart_${p.id}`), {
                    type: 'bar',
                    data: { labels: p.opts, datasets: [{ label: '# Votes', data: p.votes, backgroundColor: '#6366f1', borderRadius: 4 }] },
                    options: { plugins: { legend: {display:false} }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });
            },
            downloadResults: () => {
                let content = document.getElementById('view-vote').innerHTML;
                content += '<div style="padding: 20px; border-top: 1px solid #ccc;"><h3>Congratulations to the Winners!</h3><p>Results authenticated and audited by Supervisory Committee.</p></div>';
                const el = document.createElement('div');
                el.innerHTML = content;
                html2pdf().from(el).save('i8_Official_Results.pdf');
                App.toast('Downloading Official PDF...', 'success');
            },
            closePoll: async () => {
                try {
                    // Backend close (add PATCH /polls/:id/close)
                    const latestPoll = App.data.polls.find(p => p.active);
                    if (latestPoll) latestPoll.active = false;
                } catch (err) {
                    // Fallback
                    const latestPoll = App.data.polls.find(p => p.active);
                    if (latestPoll) latestPoll.active = false;
                }
                App.logAction('Poll Closed by Secretary', 'Secretary', App.data.polls.find(p => p.active)?.q || 'N/A');
                App.toast('Poll Closed', 'success');
                App.renderPolls();
            },
            // --- ADMIN LOGIC ---
            adminLogin: (role) => {
                App.data.role = role;
                document.getElementById('pin-title').innerText = `${role} Access`;
                document.getElementById('modal-pin').classList.remove('hidden');
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input').focus();
                App.populateSignatureSelects();
            },
            populateSignatureSelects: async () => {
                try {
                    const res = await fetch(`${API_BASE}/signatures`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    App.data.signatures = await res.json();
                } catch (err) {
                    // Fallback to local
                }
                const sigSelects = ['sec', 'treas', 'chair', 'sup', 'cm'].map(id => document.getElementById(`handover-sig-${id}`));
                sigSelects.forEach(select => {
                    if(select) {
                        select.innerHTML = '<option value="">Select Signature</option>';
                        Object.keys(App.data.signatures).forEach(role => {
                            select.innerHTML += `<option value="${role}">${App.data.signatures[role]}</option>`;
                        });
                    }
                });
            },
            verifyPin: () => {
                if(document.getElementById('pin-input').value === '1234') {
                    document.getElementById('modal-pin').classList.add('hidden');
                    document.getElementById('admin-screen-login').classList.add('hidden');
                
                    const role = App.data.role;
                    document.getElementById(`view-admin-${role}`).classList.remove('hidden');
                    document.getElementById('admin-badge').innerText = role;
                    if(role === 'Secretary') {
                        App.renderSecView();
                        App.renderMembersList();
                    }
                    if(role === 'Treasurer') App.renderTreasView();
                    if(role === 'Chairperson') {
                        App.renderChairView();
                        App.renderAnalytics();
                    }
                    if(role === 'SupervisoryCommittee') App.renderSupervisoryView();
                    if(role === 'CommitteeMember') App.renderCommitteeMemberView();
                } else alert('Invalid PIN');
            },
            adminLogout: () => {
                document.getElementById('portal-admin').classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    document.getElementById('portal-admin').classList.add('hidden');
                    document.getElementById('admin-screen-login').classList.remove('hidden');
                    document.querySelectorAll('[id^="view-admin-"]').forEach(el => el.classList.add('hidden'));
                    document.getElementById('member-pin').value = '';
                    App.data.role = null;
                }, 300);
                document.getElementById('portal-member').classList.remove('hidden');
            },
            // --- ROLE WORKFLOWS ---
            logAction: async (action, by, details) => {
                try {
                    await fetch(`${API_BASE}/logs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ action, by, details })
                    });
                } catch (err) {
                    // Fallback
                }
                App.data.logs.unshift({
                    action,
                    by,
                    details,
                    timestamp: new Date().toLocaleString()
                });
            },
            // SECRETARY
            createPoll: async () => {
                const q = document.getElementById('poll-question').value;
                const o = document.getElementById('poll-opts').value;
                if(!q || !o) return;
                try {
                    const res = await fetch(`${API_BASE}/polls`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ question: q, options: o.split(',').map(opt => opt.trim()) })
                    });
                    if (res.ok) App.renderPolls();
                } catch (err) {
                    // Fallback
                    App.data.polls.unshift({ id: Date.now(), question: q, options: o.split(',').map(opt => opt.trim()), votes: o.split(',').map(()=>0), voters: [], active: true });
                    App.renderPolls();
                }
                App.logAction('New Poll Created', 'Secretary', `Question: ${q}, Options: ${o}`);
                App.toast('Poll Created', 'success');
                document.getElementById('poll-question').value = '';
                document.getElementById('poll-opts').value = '';
            },
            addMember: async () => {
                const name = document.getElementById('new-member-name').value;
                const email = document.getElementById('new-member-email').value;
                if (!name || !email) return alert('Name and email required');
                try {
                    const res = await fetch(`${API_BASE}/members`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ name, email, pin: '0000' }) // Temp PIN
                    });
                    if (res.ok) {
                        App.renderMembersList();
                    }
                } catch (err) {
                    // Fallback
                    App.data.members.push({ name, email, hashedPin: CryptoJS.SHA256('0000').toString() });
                    App.renderMembersList();
                }
                App.logAction('New Member Added', 'Secretary', `${name} - ${email}`);
                App.toast('Member Added. They can now register with temp PIN 0000.', 'success');
                document.getElementById('new-member-name').value = '';
                document.getElementById('new-member-email').value = '';
            },
            renderMembersList: async () => {
                const el = document.getElementById('members-list');
                el.innerHTML = '';
                try {
                    const res = await fetch(`${API_BASE}/members`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    const members = await res.json();
                    App.data.members = members;
                    members.forEach(m => {
                        el.innerHTML += `<div class="flex justify-between items-center p-2 bg-white/5 rounded"><span class="text-sm text-white">${m.name} - ${m.email}</span><button onclick="App.removeMember('${m.name}')" class="text-red-400 text-xs">Remove</button></div>`;
                    });
                } catch (err) {
                    // Fallback
                    App.data.members.forEach(m => {
                        el.innerHTML += `<div class="flex justify-between items-center p-2 bg-white/5 rounded"><span class="text-sm text-white">${m.name} - ${m.email}</span><button onclick="App.removeMember('${m.name}')" class="text-red-400 text-xs">Remove</button></div>`;
                    });
                }
            },
            removeMember: async (name) => {
                if (confirm('Remove member?')) {
                    try {
                        await fetch(`${API_BASE}/members/${encodeURIComponent(name)}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${userToken}` } });
                    } catch (err) {
                        // Fallback
                    }
                    App.data.members = App.data.members.filter(m => m.name !== name);
                    App.data.welfare = App.data.welfare.filter(w => w.member !== name);
                    App.logAction('Member Removed', 'Secretary', name);
                    App.renderMembersList();
                    App.toast('Member Removed', 'success');
                }
            },
        
            submitNews: async () => {
                const txt = document.getElementById('sec-news').value;
                if(!txt) return;
                try {
                    await fetch(`${API_BASE}/news`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ text: txt, signed_by: 'Secretary' })
                    });
                    App.renderNews();
                } catch (err) {
                    // Fallback: Push to chairQueue
                    App.data.chairQueue.push({ id: Date.now(), type: 'News', data: txt, author: 'Secretary' });
                }
                App.logAction('News Draft Submitted to Chair', 'Secretary', txt.substring(0, 100) + (txt.length > 100 ? '...' : ''));
                document.getElementById('sec-news').value = '';
                App.toast('Draft sent to Chair for Approval', 'info');
            },
            renderSecView: async () => {
                // Filter Welfare for Step 1 (Sec) - backend query if added
                const queue = App.data.welfare.filter(w => w.status === 'Sec');
                const el = document.getElementById('sec-welfare-queue');
                el.innerHTML = queue.length ? '' : '<p class="text-slate-500 text-sm">No new welfare claims to record.</p>';
                queue.forEach(w => {
                    el.innerHTML += `<div class="bg-dark-900 p-3 rounded-lg border border-white/10 flex justify-between items-center"><span class="text-white text-sm">${w.member}: ${w.type} (${w.amount})</span><button onclick="App.pushWelfare('${w.id}', 'Treas')" class="bg-blue-600 text-xs px-3 py-1 rounded text-white">Record & Fwd</button></div>`;
                });
            },
            // TREASURER (similar pattern for all roles)
            renderTreasView: async () => {
                const queue = App.data.welfare.filter(w => w.status === 'Treas');
                const el = document.getElementById('treas-welfare-queue');
                el.innerHTML = queue.length ? '' : '<p class="text-slate-500 text-sm">No approved claims awaiting funds.</p>';
                queue.forEach(w => {
                    el.innerHTML += `<div class="bg-dark-900 p-3 rounded-lg border border-white/10 flex justify-between items-center"><span class="text-white text-sm">${w.member}: ${w.type} (${w.amount})</span><button onclick="App.pushWelfare('${w.id}', 'Chair')" class="bg-emerald-600 text-xs px-3 py-1 rounded text-white">Allocate Funds</button></div>`;
                });
            },
            handleUpload: (event) => {
                const file = event.target.files[0];
                if (file) {
                    document.getElementById('treas-file-name').innerText = file.name;
                }
            },
            submitFinancialReport: async () => {
                const reportText = document.getElementById('treas-report').value;
                const fileName = document.getElementById('treas-file-name').innerText;
                if(!reportText && !fileName) return;
                try {
                    await fetch(`${API_BASE}/approved-reports`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ text: reportText, file: fileName, signed_by: 'Treasurer' })
                    });
                    App.renderApprovedReports();
                } catch (err) {
                    // Fallback
                    App.data.chairQueue.push({ id: Date.now(), type: 'FinancialReport', data: { text: reportText, file: fileName }, author: 'Treasurer' });
                }
                App.logAction('Financial Report Submitted to Chair', 'Treasurer', reportText.substring(0, 100) + (reportText.length > 100 ? '...' : '') + (fileName ? ` | File: ${fileName}` : ''));
                document.getElementById('treas-report').value = '';
                document.getElementById('treas-file-name').innerText = '';
                document.getElementById('treas-upload').value = '';
                App.toast('Report sent to Chair for Approval', 'info');
            },
            pushWelfare: async (id, nextStatus) => {
                try {
                    // Backend update (add PATCH /welfare/:id)
                    const w = App.data.welfare.find(x => x.id == id);
                    w.status = nextStatus;
                } catch (err) {
                    // Fallback
                    const item = App.data.welfare.find(w => w.id == id);
                    const prevStatus = item.status;
                    item.status = nextStatus;
                    if(nextStatus === 'Chair') {
                        App.data.chairQueue.push({ id: Date.now(), type: 'Welfare', data: item, author: App.data.role });
                    }
                }
                App.logAction(`Welfare Advanced from ${prevStatus} to ${nextStatus}`, App.data.role, `${item.member}: ${item.type}, Amount: KES ${item.amount}`);
                if(App.data.role === 'Secretary') App.renderSecView();
                if(App.data.role === 'Treasurer') App.renderTreasView();
                App.toast('Workflow Advanced', 'success');
            },
            // CHAIRPERSON
            renderChairView: async () => {
                try {
                    const res = await fetch(`${API_BASE}/chair-queue`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    App.data.chairQueue = await res.json();
                } catch (err) {
                    // Fallback to local
                }
                const el = document.getElementById('chair-queue');
                el.innerHTML = App.data.chairQueue.length ? '' : '<p class="text-slate-500 text-sm italic">Nothing pending authorization.</p>';
            
                App.data.chairQueue.forEach((item, idx) => {
                    let desc = '';
                    let action = '';
                
                    if(item.type === 'News') {
                        desc = `<span class="text-blue-400 font-bold">COMMUNICATION:</span> "${item.data}"`;
                        action = 'Approve & Publish';
                    } else if (item.type === 'Welfare') {
                        desc = `<span class="text-pink-400 font-bold">WELFARE RELEASE:</span> Pay ${item.data.member} KES ${item.data.amount}`;
                        action = 'Sign & Release';
                    } else if (item.type === 'FinancialReport') {
                        desc = `<span class="text-emerald-400 font-bold">FINANCIAL REPORT:</span> ${item.data.text.substring(0, 50)}... ${item.data.file ? `| File: ${item.data.file}` : ''}`;
                        action = 'Approve & Publish to Members';
                    } else if (item.type === 'CommitteeNote') {
                        desc = `<span class="text-orange-400 font-bold">COMMITTEE NOTE:</span> ${item.data.note} on ${item.data.section}`;
                        action = 'Acknowledge';
                    }
                    el.innerHTML += `
                    <div class="bg-dark-900 p-4 rounded-xl border-l-4 border-purple-500 animate-slide-up">
                        <div class="flex justify-between mb-2"><span class="text-[10px] uppercase text-slate-500 font-bold">From: ${item.author}</span><span class="text-[10px] uppercase text-purple-400 font-bold">Action Required</span></div>
                        <p class="text-sm text-white mb-3">${desc}</p>
                        <button onclick="App.chairApprove(${idx})" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded-lg text-xs flex items-center justify-center gap-2"><i class="fa-solid fa-file-signature"></i> ${action}</button>
                    </div>`;
                });
            },
            chairApprove: async (idx) => {
                const item = App.data.chairQueue[idx];
            
                if(item.type === 'News') {
                    try {
                        await fetch(`${API_BASE}/news`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                            body: JSON.stringify({ text: item.data, signed_by: App.data.signatures.Chairperson })
                        });
                        App.renderNews();
                    } catch (err) {
                        // Fallback
                        App.data.news.unshift({ text: item.data, signedBy: App.data.signatures.Chairperson });
                    }
                    App.logAction('News Approved & Published', 'Chairperson', item.data.substring(0, 100) + (item.data.length > 100 ? '...' : ''));
                } else if (item.type === 'Welfare') {
                    const w = App.data.welfare.find(x => x.id == item.data.id);
                    if(w) {
                        w.status = 'Paid';
                        try {
                            await fetch(`${API_BASE}/transactions`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                                body: JSON.stringify({ title: `Welfare: ${w.type}`, date: 'Today', amount: w.amount, type: 'out', member: w.member })
                            });
                            App.renderFinance();
                        } catch (err) {
                            // Fallback
                            App.data.transactions.unshift({ t: `Welfare: ${w.type}`, d: 'Today', a: w.amount, type: 'out', member: w.member });
                        }
                        App.addPersonalNotification(`${w.member}, your welfare claim has been approved and paid.`);
                    }
                 
                    App.logAction('Welfare Released & Paid', 'Chairperson', `${w.member}: ${w.type}, Amount: KES ${w.amount}`);
                } else if (item.type === 'FinancialReport') {
                    try {
                        await fetch(`${API_BASE}/approved-reports`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                            body: JSON.stringify({ ...item.data, signedBy: App.data.signatures.Chairperson })
                        });
                        App.renderApprovedReports();
                    } catch (err) {
                        // Fallback
                        App.data.approvedReports.unshift({ ...item.data, signedBy: App.data.signatures.Chairperson });
                    }
                    App.logAction('Financial Report Approved & Published to Members', 'Chairperson', `${item.data.text.substring(0, 50)}... ${item.data.file ? `| File: ${item.data.file}` : ''}`);
                } else if (item.type === 'CommitteeNote') {
                    App.logAction('Committee Note Acknowledged', 'Chairperson', `${item.data.note} on ${item.data.section}`);
                }
                try {
                    await fetch(`${API_BASE}/chair-queue/${item.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${userToken}` } });
                } catch (err) {
                    // Fallback
                }
                App.data.chairQueue.splice(idx, 1);
                App.renderChairView();
                App.toast('Signed & Authorized.', 'success');
            },
            publishDirectComm: async () => {
                const txt = document.getElementById('chair-comm').value;
                if (!txt) return;
                try {
                    await fetch(`${API_BASE}/news`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ text: txt, signed_by: App.data.signatures.Chairperson })
                    });
                    App.renderNews();
                } catch (err) {
                    // Fallback
                    App.data.news.unshift({ text: txt, signedBy: App.data.signatures.Chairperson });
                }
                App.logAction('Direct Communication Published', 'Chairperson', txt.substring(0, 100));
                document.getElementById('chair-comm').value = '';
                App.toast('Published to All Members', 'success');
            },
            renderAnalytics: () => {
                const ctx = document.getElementById('analytics-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Welfare Claims', 'Polls Active', 'Members'],
                        datasets: [{ data: [App.data.welfare.length, App.data.polls.filter(p => p.active).length, App.data.members.length], backgroundColor: ['#ef4444', '#3b82f6', '#10b981'] }]
                    },
                    options: { plugins: { legend: { position: 'bottom' } } }
                });
            },
            // SUPERVISORY
            renderSupervisoryView: async () => {
                try {
                    const res = await fetch(`${API_BASE}/logs`, { headers: { 'Authorization': `Bearer ${userToken}` } });
                    App.data.logs = await res.json();
                } catch (err) {
                    // Fallback
                }
                const el = document.getElementById('supervisory-logs');
                el.innerHTML = App.data.logs.length ? '' : '<p class="text-slate-500 text-sm italic">No logged actions yet.</p>';
                App.data.logs.forEach(log => {
                    el.innerHTML += `
                        <div class="p-3 bg-dark-900 rounded-lg border border-white/5">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs text-gray-400 font-bold uppercase">${log.action}</span>
                                <span class="text-xs text-slate-500">${log.timestamp}</span>
                            </div>
                            <p class="text-sm text-white mb-2">${log.details}</p>
                            <div class="text-xs text-gray-500">By: <span class="font-bold">${log.by}</span></div>
                        </div>`;
                });
            },
            downloadAuditReport: () => {
                const el = document.getElementById('view-admin-SupervisoryCommittee');
                html2pdf().from(el).save('i8_Audit_Report.pdf');
                App.toast('Downloading Audit Report PDF...', 'success');
             
                App.logAction('Audit Report Downloaded', 'SupervisoryCommittee', 'Full compliance logs exported for review');
            },
            // COMMITTEE MEMBER
            renderCommitteeMemberView: async () => {
                // Similar fetches for queues (welfare, chairQueue filtered)
                const welfareEl = document.getElementById('cm-welfare-view');
                const newsEl = document.getElementById('cm-news-view');
                const finEl = document.getElementById('cm-fin-report-view');
                // ... (render from App.data as before)
                // Use chairQueue filter for news/fin
                const welfareQueue = App.data.welfare.filter(w => w.status !== 'Paid');
                welfareEl.innerHTML = welfareQueue.length ? '' : '<p class="text-slate-500 text-sm">No pending welfare.</p>';
                welfareQueue.forEach(w => {
                    welfareEl.innerHTML += `<div class="text-xs text-white">${w.member}: ${w.type} - KES ${w.amount} (${w.status})</div>`;
                });
                const newsQueue = App.data.chairQueue.filter(c => c.type === 'News');
                newsEl.innerHTML = newsQueue.length ? '' : '<p class="text-slate-500 text-sm">No pending news.</p>';
                newsQueue.forEach(n => {
                    newsEl.innerHTML += `<div class="text-xs text-white">${n.data.substring(0, 50)}...</div>`;
                });
                const finQueue = App.data.chairQueue.filter(c => c.type === 'FinancialReport');
                finEl.innerHTML = finQueue.length ? '' : '<p class="text-slate-500 text-sm">No pending reports.</p>';
                finQueue.forEach(f => {
                    finEl.innerHTML += `<div class="text-xs text-white">${f.data.text.substring(0, 50)}... ${f.data.file ? `| ${f.data.file}` : ''}</div>`;
                });
            },
            addCommitteeNote: async (section) => {
                const note = document.getElementById(`cm-${section}-note`).value;
                if(!note) return;
                try {
                    await fetch(`${API_BASE}/chair-queue`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ type: 'CommitteeNote', data: { note, section }, author: 'CommitteeMember' })
                    });
                    App.renderChairView(); // Refresh for all
                } catch (err) {
                    // Fallback
                    App.data.chairQueue.push({
                        id: Date.now(),
                        type: 'CommitteeNote',
                        data: { note, section },
                        author: 'CommitteeMember'
                    });
                }
                App.logAction('Committee Note Submitted to Chair', 'CommitteeMember', `${note.substring(0, 50)}... on ${section}`);
                document.getElementById(`cm-${section}-note`).value = '';
                App.toast('Note sent to Chair', 'info');
                App.renderCommitteeMemberView();
            },
            // HANDOVER
            executeHandover: async (context) => {
                const currentRole = {sec: 'Secretary', treas: 'Treasurer', chair: 'Chairperson', sup: 'SupervisoryCommittee', cm: 'CommitteeMember'}[context];
                const nameInput = document.getElementById(`handover-name-${context}`);
                const sigSelect = document.getElementById(`handover-sig-${context}`);
                const name = nameInput.value;
                const sig = sigSelect.value;
                if(!name || !sig) return alert('Name and signature required');
             
                try {
                    await fetch(`${API_BASE}/signatures/${currentRole}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` },
                        body: JSON.stringify({ signature: sig })
                    });
                    App.data.signatures[currentRole] = sig;
                } catch (err) {
                    // Fallback
                    App.data.signatures[currentRole] = sig;
                }
             
                App.logAction('Admin Handover Executed', App.data.role, `${currentRole}: New: ${name}, Signature: ${sig}`);
             
                nameInput.value = '';
                sigSelect.value = '';
             
                App.toast(`Handover to ${name} as ${currentRole} completed.`, 'success');
            },
            // PLACEHOLDERS
            uploadSlip: () => App.toast('Upload functionality placeholder.', 'info'),
            toast: (msg, type) => {
                const box = document.getElementById('toast-box');
                const el = document.createElement('div');
                let color = '';
                if (type === 'success') color = 'text-emerald-400 border-emerald-500/30';
                else if (type === 'error') color = 'text-red-400 border-red-500/30';
                else color = 'text-blue-400 border-blue-500/30';
                el.className = `glass ${color} px-4 py-3 rounded-xl shadow-2xl text-sm font-bold flex items-center gap-2 animate-fade-in border`;
                el.innerHTML = `<i class="fa-solid fa-circle-info"></i> ${msg}`;
                box.appendChild(el);
                setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
            }
        };
        window.onload = () => { setTimeout(() => document.getElementById('splash-screen').classList.add('opacity-0', 'pointer-events-none'), 1500); };
    </script>
</body>
</html>
