<script>
  const API_BASE = 'https://app-backend-xil0.onrender.com'; // Your live backend URL
  let userToken = localStorage.getItem('token') || '';
  let currentUserRole = 'member';
  let deferredPrompt; // For PWA install
  const App = {
    data: {
      user: '',
      role: 'member',
      news: [],
      polls: [],
      approvedReports: [],
      welfare: [],
      chairQueue: [],
      transactions: [],
      logs: [],
      members: [],
      signatures: {},
      notifications: [],
      loans: []
    },
    showSpinner: (id, show = true) => {
      if (id) document.getElementById(id)?.classList.toggle('hidden', !show);
      document.body.classList.toggle('loading', show);
    },
    toast: (msg, type = 'info') => {
      const toast = document.createElement('div');
      toast.className = `p-3 rounded-lg fixed top-6 left-1/2 transform -translate-x-1/2 z-[200] ${type === 'error' ? 'bg-red-500/20 border-red-500/30 text-red-300' : type === 'success' ? 'bg-green-500/20 border-green-500/30 text-green-300' : 'bg-blue-500/20 border-blue-500/30 text-blue-300'} border animate-fade-in max-w-sm w-full px-4 pointer-events-auto`;
      toast.innerHTML = `${msg} <button onclick="this.parentElement.remove()" class="float-right text-xs">&times;</button>`;
      toast.setAttribute('role', 'alert');
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    },
    fetchWithAuth: async (endpoint, options = {}) => {
      const headers = { 'Content-Type': 'application/json', ...options.headers };
      if (userToken) headers.Authorization = `Bearer ${userToken}`;
      try {
        const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
        if (!res.ok) {
          const contentType = res.headers.get('content-type');
          const errText = await res.text();
          if (!contentType || !contentType.includes('application/json')) {
            // Handle non-JSON (e.g., SW offline text or 503)
            throw new Error(`Server error: ${res.status} - ${errText.substring(0,100)} (Check connection)`);
          }
          try {
            const err = JSON.parse(errText);
            throw new Error(err.error || 'Request failed');
          } catch {
            throw new Error(`Server error: ${res.status} - ${errText.substring(0,100)}`);
          }
        }
        return await res.json();
      } catch (err) {
        App.toast(err.message || 'Network error - Check connection and retry', 'error');
        throw err;
      }
    },
    // ... (rest of your script unchanged – it's already complete and works)
    initPWA: () => {
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        setTimeout(() => {
          if (deferredPrompt && document.getElementById('portal-member').classList.contains('hidden') === false) {
            const promptToast = document.createElement('div');
            promptToast.className = 'fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-brand-600 text-white p-4 rounded-xl z-[200] flex items-center gap-3 max-w-sm';
            promptToast.innerHTML = '<i class="fa-solid fa-download"></i> Install i8 Portal App? <button id="install-btn" class="ml-4 bg-white text-brand-600 px-4 py-1 rounded font-bold">Install</button> <button onclick="this.parentElement.remove()" class="ml-2 text-white">&times;</button>';
            document.body.appendChild(promptToast);
            document.getElementById('install-btn')?.addEventListener('click', App.handleInstall);
          }
        }, 5000);
      });
    },
    handleInstall: async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') deferredPrompt = null;
      document.querySelector('[id="install-btn"]').parentElement.remove();
    },
    memberLogin: async () => {
      const email = document.getElementById('login-email').value.trim();
      const pin = document.getElementById('member-pin').value;
      if (!email || !pin || pin.length !== 4 || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return App.toast('Valid email and 4-digit PIN required', 'error');
      // Offline check before fetch
      if (!navigator.onLine) return App.toast('Offline - Please connect to internet', 'error');
      App.showSpinner('login-spinner');
      try {
        const data = await App.fetchWithAuth('/auth', { method: 'POST', body: JSON.stringify({ email, pin }) });
        App.data.user = data.user.name;
        currentUserRole = data.user.role;
        localStorage.setItem('token', data.token);
        userToken = data.token;
        document.getElementById('screen-auth').classList.add('opacity-0', 'pointer-events-none');
        setTimeout(() => {
          document.getElementById('screen-auth').classList.add('hidden');
          document.getElementById('portal-member').classList.remove('hidden');
          document.getElementById('welcome-user').textContent = App.data.user;
          const adminBtn = document.querySelectorAll('[onclick="App.switchToAdmin()"]');
          adminBtn.forEach(btn => {
            if (['secretary', 'treasurer', 'chairperson', 'supervisorycommittee', 'committeemember'].includes(currentUserRole)) {
              btn.classList.remove('hidden');
            }
          });
          App.renderAll();
          App.renderNotifications();
          App.initPWA(); // Trigger install after login
        }, 500);
      } catch (err) {
        // Error handled in fetchWithAuth
      } finally {
        App.showSpinner('login-spinner', false);
        document.getElementById('login-email').value = '';
        document.getElementById('member-pin').value = '';
      }
    },
    // ... (all other methods unchanged – copy from your original for brevity)
    resetPin: async () => {
      const email = document.getElementById('login-email').value.trim();
      if (!email) return App.toast('Enter email first', 'error');
      try {
        await App.fetchWithAuth('/reset-pin', { method: 'POST', body: JSON.stringify({ email }) });
        App.toast('PIN reset to 1234. Check your email or login now.', 'success');
      } catch {}
    },
    showRegister: () => {
      document.getElementById('screen-auth').classList.add('hidden');
      document.getElementById('screen-register').classList.remove('hidden');
    },
    showLogin: () => {
      document.getElementById('screen-register').classList.add('hidden');
      document.getElementById('screen-auth').classList.remove('hidden');
    },
    registerMember: async () => {
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const pin = document.getElementById('reg-pin').value;
      if (!name || !email || pin.length !== 4 || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return App.toast('Valid details required', 'error');
      App.showSpinner('reg-spinner');
      try {
        await App.fetchWithAuth('/members', { method: 'POST', body: JSON.stringify({ name, email, pin }) });
        App.toast('Registered! Login with your PIN.', 'success');
        App.showLogin();
      } catch {}
      finally {
        App.showSpinner('reg-spinner', false);
        document.getElementById('reg-name').value = '';
        document.getElementById('reg-email').value = '';
        document.getElementById('reg-pin').value = '';
      }
    },
    nav: (view) => {
      document.querySelectorAll('[id^="nav-"]').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`nav-${view}`)?.classList.add('active');
      document.getElementById('header-title').textContent = view.charAt(0).toUpperCase() + view.slice(1);
      document.querySelectorAll('[id^="view-"]').forEach(sec => sec.classList.add('hidden'));
      document.getElementById(`view-${view}`).classList.remove('hidden');
      if (view === 'dashboard') App.renderDashboard();
      else if (view === 'finance') App.renderFinance();
      else if (view === 'welfare') App.renderWelfare();
      else if (view === 'vote') App.renderPolls();
      else if (view === 'profile') App.renderProfile();
    },
    renderAll: async () => {
      await Promise.all([
        App.loadNews(),
        App.loadPolls(),
        App.loadApprovedReports(),
        App.loadWelfare(),
        App.loadTransactions()
      ]);
      document.getElementById('dash-liquidity').textContent = 'KES ' + App.data.transactions.reduce((sum, t) => sum + (t.type === 'credit' ? t.amount : -t.amount), 0);
      document.getElementById('dash-poll-count').textContent = App.data.polls.filter(p => p.active).length;
      document.getElementById('dash-welfare-status').textContent = App.data.welfare.length ? 'Pending Claims' : 'Good Standing';
    },
    loadNews: async () => { App.data.news = await App.fetchWithAuth('/news'); App.renderNews(); },
    renderNews: () => { document.getElementById('member-news-feed').innerHTML = App.data.news.map(n => `<div class="p-3 bg-white/5 rounded"><p class="text-sm">${n.text}</p><span class="text-xs text-slate-400">${n.signedBy} - ${n.createdAt}</span></div>`).join('') || '<p>No updates.</p>'; },
    loadPolls: async () => { App.data.polls = await App.fetchWithAuth('/polls'); App.renderPolls(); },
    renderPolls: () => {
      const container = document.getElementById('polls-container');
      container.innerHTML = App.data.polls.map(p => `
        <div class="glass p-4 rounded-xl">
          <h4 class="font-bold text-white mb-2">${p.question}</h4>
          ${p.options.map((opt, i) => `<button onclick="App.vote(${p.id}, ${i})" class="block w-full text-left p-2 bg-white/5 rounded mb-1">${opt} (${p.votes[i]} votes)</button>`).join('')}
        </div>
      `).join('') || '<p>No active polls.</p>';
      document.getElementById('download-btn').classList.toggle('hidden', App.data.polls.length === 0);
    },
    vote: async (pollId, optionIdx) => {
      try {
        const polls = await App.fetchWithAuth('/polls'); // Refetch or patch endpoint
        const poll = polls.find(p => p.id === pollId);
        if (poll.voters.includes(App.data.user)) return App.toast('Already voted', 'error');
        poll.votes[optionIdx]++;
        poll.voters.push(App.data.user);
        await App.fetchWithAuth(`/polls/${pollId}`, { method: 'PATCH', body: JSON.stringify({ votes: poll.votes, voters: poll.voters }) }); // Assume backend supports
        App.renderPolls();
      } catch {}
    },
    loadApprovedReports: async () => { App.data.approvedReports = await App.fetchWithAuth('/approved-reports'); App.renderApprovedReports(); },
    renderApprovedReports: () => { document.getElementById('approved-reports').innerHTML = App.data.approvedReports.map(r => `<div class="p-3 bg-white/5 rounded"><p>${r.text}</p><span class="text-xs">${r.signedBy}</span></div>`).join('') || '<p>No reports.</p>'; },
    loadWelfare: async () => { App.data.welfare = await App.fetchWithAuth('/welfare'); App.renderWelfare(); },
    renderWelfare: () => { document.getElementById('welfare-list').innerHTML = App.data.welfare.map(w => `<div class="p-3 bg-pink-900/20 rounded"> ${w.type}: KES ${w.amount} - ${w.status} </div>`).join('') || '<p>No claims.</p>'; },
    loadTransactions: async () => { App.data.transactions = await App.fetchWithAuth('/transactions'); App.renderTransactions(); },
    renderTransactions: () => { document.getElementById('finance-list').innerHTML = App.data.transactions.map(t => `<div class="p-3 flex justify-between"><span>${t.title} - ${t.type}</span><span>KES ${t.amount}</span></div>`).join('') || '<p>No transactions.</p>'; },
    renderDashboard: () => App.renderAll(), // Alias
    renderFinance: () => App.renderTransactions(),
    renderWelfare: () => { /* Already loaded */ },
    renderPolls: () => { /* Already loaded */ },
    renderProfile: () => {
      document.getElementById('profile-name').value = App.data.user;
      document.getElementById('profile-email').value = App.data.user; // Placeholder; fetch from token
    },
    toggleNotifications: () => {
      const panel = document.getElementById('notifications-panel');
      panel.classList.toggle('hidden');
    },
    renderNotifications: async () => {
      try {
        App.data.notifications = await App.fetchWithAuth('/notifications');
        document.getElementById('notif-list').innerHTML = App.data.notifications.map(n => `<div class="p-2 bg-white/5 rounded cursor-pointer" onclick="App.markRead(${n.id})">${n.message}</div>`).join('');
        document.getElementById('notif-badge').textContent = App.data.notifications.filter(n => !n.read).length;
        document.getElementById('notif-badge').classList.toggle('hidden', App.data.notifications.filter(n => !n.read).length === 0);
      } catch {}
    },
    markRead: async (id) => {
      await App.fetchWithAuth(`/notifications/${id}/read`, { method: 'PATCH' });
      App.renderNotifications();
    },
    uploadSlip: async () => { App.toast('Upload via M-Pesa USSD or bank app, then record manually.', 'info'); }, // Placeholder; add file upload if needed
    openLoanModal: () => document.getElementById('modal-loan').classList.remove('hidden'),
    submitLoan: async () => {
      const amount = document.getElementById('loan-amount').value;
      const purpose = document.getElementById('loan-purpose').value;
      if (!amount || !purpose) return App.toast('Fill all fields', 'error');
      App.showSpinner('loan-spinner');
      try {
        await App.fetchWithAuth('/loans', { method: 'POST', body: JSON.stringify({ amount, purpose, member: App.data.user }) });
        App.toast('Loan submitted!', 'success');
        document.getElementById('modal-loan').classList.add('hidden');
        document.getElementById('loan-amount').value = '';
        document.getElementById('loan-purpose').value = '';
        App.renderFinance();
      } catch {}
      finally { App.showSpinner('loan-spinner', false); }
    },
    openWelfareModal: () => document.getElementById('modal-welfare').classList.remove('hidden'),
    submitWelfare: async () => {
      const type = document.getElementById('welfare-type').value;
      const amount = document.getElementById('welfare-amount').value;
      if (!type || !amount) return App.toast('Fill all fields', 'error');
      App.showSpinner('welfare-spinner');
      try {
        await App.fetchWithAuth('/welfare', { method: 'POST', body: JSON.stringify({ type, amount, member: App.data.user }) });
        App.toast('Claim submitted!', 'success');
        document.getElementById('modal-welfare').classList.add('hidden');
        document.getElementById('welfare-amount').value = '';
        App.renderWelfare();
      } catch {}
      finally { App.showSpinner('welfare-spinner', false); }
    },
    switchToAdmin: () => document.getElementById('modal-admin-pin').classList.remove('hidden'),
    verifyAdminPin: async () => {
      const pin = document.getElementById('admin-pin-input').value;
      if (pin.length !== 4) return App.toast('4-digit PIN required', 'error');
      App.showSpinner('admin-pin-spinner');
      try {
        const data = await App.fetchWithAuth('/auth/admin-pin', { method: 'POST', body: JSON.stringify({ pin }) }); // Assume backend endpoint
        userToken = data.token;
        localStorage.setItem('token', userToken);
        document.getElementById('modal-admin-pin').classList.add('hidden');
        document.getElementById('portal-member').classList.add('hidden');
        document.getElementById('portal-admin').classList.remove('hidden', 'opacity-0', 'scale-95');
        App.adminLogin(currentUserRole);
      } catch (err) {
        App.toast(err.message || 'Invalid PIN', 'error');
      } finally {
        App.showSpinner('admin-pin-spinner', false);
        document.getElementById('admin-pin-input').value = '';
      }
    },
    adminLogin: (role) => {
      document.querySelectorAll('[id^="view-admin-"]').forEach(v => v.classList.add('hidden'));
      document.getElementById(`view-admin-${role}`).classList.remove('hidden');
      document.getElementById('admin-badge').textContent = 'Active';
      document.getElementById('admin-badge').className = 'text-[10px] bg-green-500/20 px-2 py-0.5 rounded text-green-400 ml-2 uppercase';
      if (role === 'secretary') App.renderSecretaryDash();
      else if (role === 'treasurer') App.renderTreasurerDash();
      else if (role === 'chairperson') App.renderChairDash();
      else if (role === 'supervisorycommittee') App.renderSupervisoryDash();
      else if (role === 'committeemember') App.renderCommitteeDash();
    },
    adminLogout: () => {
      document.getElementById('portal-admin').classList.add('hidden', 'opacity-0', 'scale-95');
      document.getElementById('portal-member').classList.remove('hidden');
      document.getElementById('admin-badge').textContent = 'Locked';
      document.getElementById('admin-badge').className = 'text-[10px] bg-white/10 px-2 py-0.5 rounded text-slate-400 ml-2 uppercase';
    },
    // Admin Methods (examples; expand as needed)
    createPoll: async () => {
      const question = document.getElementById('poll-question').value;
      const opts = document.getElementById('poll-opts').value.split(',').map(o => o.trim());
      if (!question || opts.length < 2) return App.toast('Valid question and 2+ options', 'error');
      App.showSpinner('poll-spinner');
      try {
        await App.fetchWithAuth('/polls', { method: 'POST', body: JSON.stringify({ question, options: opts }) });
        App.toast('Poll launched!', 'success');
        document.getElementById('poll-question').value = '';
        document.getElementById('poll-opts').value = '';
        App.renderPolls();
      } catch {}
      finally { App.showSpinner('poll-spinner', false); }
    },
    closePoll: async () => { /* Implement poll close endpoint */ App.toast('Poll closed', 'success'); },
    submitMinutes: async () => {
      const text = document.getElementById('minutes-text').value;
      if (!text) return App.toast('Enter minutes', 'error');
      App.showSpinner('minutes-spinner');
      try {
        await App.fetchWithAuth('/chair-queue', { method: 'POST', body: JSON.stringify({ type: 'Minutes', data: { text }, author: App.data.user }) });
        App.toast('Submitted to Chair', 'success');
        document.getElementById('minutes-text').value = '';
      } catch {}
      finally { App.showSpinner('minutes-spinner', false); }
    },
    handleDocUpload: async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64 = e.target.result.split(',')[1]; // Remove data URL prefix
        document.getElementById('doc-file-name').textContent = `Uploaded: ${file.name}`;
        await App.fetchWithAuth('/upload-docs', { method: 'POST', body: JSON.stringify({ fileName: file.name, fileData: base64, signedBy: App.data.user }) });
        App.toast('Document uploaded', 'success');
      };
      reader.readAsDataURL(file);
    },
    addMember: async () => {
      const name = document.getElementById('new-member-name').value.trim();
      const email = document.getElementById('new-member-email').value.trim();
      const pin = prompt('Set 4-digit PIN:'); // Simple; use modal in prod
      if (!name || !email || !pin || pin.length !== 4) return App.toast('Valid details', 'error');
      try {
        await App.fetchWithAuth('/members', { method: 'POST', body: JSON.stringify({ name, email, pin }) });
        App.toast('Member added', 'success');
        document.getElementById('new-member-name').value = '';
        document.getElementById('new-member-email').value = '';
        App.loadMembers();
      } catch {}
    },
    loadMembers: async () => { App.data.members = await App.fetchWithAuth('/members'); App.renderMembers(); },
    renderMembers: () => { document.getElementById('members-list').innerHTML = App.data.members.map(m => `<div class="p-2 bg-white/5 rounded">${m.name} (${m.role})</div>`).join('') || '<p>No members.</p>'; },
    submitNews: async () => {
      const text = document.getElementById('sec-news').value;
      if (!text) return App.toast('Enter news', 'error');
      try {
        await App.fetchWithAuth('/news', { method: 'POST', body: JSON.stringify({ text, signed_by: App.data.user }) });
        App.toast('Submitted to Chair', 'success');
        document.getElementById('sec-news').value = '';
        App.loadNews();
      } catch {}
    },
    executeHandover: async (role) => {
      const name = document.getElementById(`handover-name-${role}`).value.trim();
      const sig = document.getElementById(`handover-sig-${role}`).value;
      if (!name || !sig) return App.toast('Name and signature required', 'error');
      try {
        await App.fetchWithAuth('/handover', { method: 'POST', body: JSON.stringify({ role, name, signature: sig }) });
        App.toast('Handover executed', 'success');
      } catch {}
    },
    renderSecretaryDash: async () => {
      await App.loadMembers();
      try {
        const welfare = await App.fetchWithAuth('/welfare?status=Pending');
        document.getElementById('sec-welfare-queue').innerHTML = welfare.map(w => `<div class="p-2 bg-blue-900/20 rounded">${w.member}: ${w.type} - KES ${w.amount}</div>`).join('') || '<p>No queue.</p>';
      } catch { App.toast('Load failed', 'error'); }
    },
    renderTreasurerDash: async () => {
      await App.renderPendingLoans();
      try {
        const welfare = await App.fetchWithAuth('/welfare?status=Pending');
        document.getElementById('treas-welfare-queue').innerHTML = welfare.map(w => `<div class="p-2 bg-emerald-900/20 rounded">${w.member}: KES ${w.amount}</div>`).join('');
      } catch {}
    },
    renderPendingLoans: async () => {
      try {
        const loans = await App.fetchWithAuth('/loans?status=Pending');
        document.getElementById('pending-loans').innerHTML = loans.map(l => `
          <div class="p-3 bg-white/5 rounded flex justify-between">
            <span>${l.member}: ${l.purpose} (KES ${l.amount})</span>
            <button onclick="App.approveLoan(${l.id}, 'Approved')" class="bg-emerald-600 text-white px-3 py-1 rounded mr-2"><span class="spinner hidden" id="loan-${l.id}-spinner"></span>Approve</button>
            <button onclick="App.approveLoan(${l.id}, 'Rejected')" class="bg-red-600 text-white px-3 py-1 rounded">Reject</button>
          </div>
        `).join('') || '<p>No pending.</p>';
      } catch { App.toast('Load failed', 'error'); }
    },
    approveLoan: async (id, status) => {
      App.showSpinner(`loan-${id}-spinner`);
      try {
        await App.fetchWithAuth(`/loans/${id}`, { method: 'PATCH', body: JSON.stringify({ status }) });
        App.toast(`${status} loan`, 'success');
        App.renderPendingLoans();
      } catch {}
      finally { App.showSpinner(`loan-${id}-spinner`, false); }
    },
    submitFinancialReport: async () => {
      const text = document.getElementById('treas-report').value;
      if (!text) return App.toast('Enter report', 'error');
      App.showSpinner('report-spinner');
      try {
        await App.fetchWithAuth('/approved-reports', { method: 'POST', body: JSON.stringify({ text, signedBy: App.data.user }) });
        App.toast('Submitted to Chair', 'success');
        document.getElementById('treas-report').value = '';
      } catch {}
      finally { App.showSpinner('report-spinner', false); }
    },
    renderChairDash: async () => {
      try {
        App.data.chairQueue = await App.fetchWithAuth('/chair-queue');
        document.getElementById('chair-queue').innerHTML = App.data.chairQueue.map(q => `
          <div class="p-3 bg-purple-900/20 rounded">
            <p>${q.type}: ${q.data?.text || q.data?.purpose || ''}</p>
            <button onclick="App.approveQueue('${q.id}')" class="bg-purple-600 text-white px-3 py-1 rounded">Approve & Sign</button>
          </div>
        `).join('') || '<p>No queue.</p>';
      } catch { App.toast('Load failed', 'error'); }
    },
    approveQueue: async (id) => {
      const sig = prompt('Enter signature text:'); // Use select in prod
      if (!sig) return;
      try {
        await App.fetchWithAuth(`/chair-queue/${id}/approve`, { method: 'PATCH', body: JSON.stringify({ signature: sig }) });
        App.toast('Approved', 'success');
        App.renderChairDash();
      } catch {}
    },
    publishDirectComm: async () => {
      const text = document.getElementById('chair-comm').value;
      if (!text) return App.toast('Enter message', 'error');
      try {
        await App.fetchWithAuth('/news', { method: 'POST', body: JSON.stringify({ text, signed_by: App.data.user }) });
        App.toast('Published', 'success');
        document.getElementById('chair-comm').value = '';
        App.loadNews();
      } catch {}
    },
    promoteMember: async () => {
      const email = document.getElementById('promote-email').value;
      const role = document.getElementById('promote-role').value;
      if (!email || !role) return App.toast('Select email and role', 'error');
      App.showSpinner('promote-spinner');
      try {
        await App.fetchWithAuth(`/members/${email}/promote`, { method: 'POST', body: JSON.stringify({ role }) });
        App.toast('Promoted', 'success');
        document.getElementById('promote-email').value = '';
        document.getElementById('promote-role').value = '';
        App.loadMembers();
      } catch {}
      finally { App.showSpinner('promote-spinner', false); }
    },
    renderSupervisoryDash: async () => {
      try {
        App.data.logs = await App.fetchWithAuth('/logs');
        document.getElementById('supervisory-logs').innerHTML = App.data.logs.map(l => `<div class="p-2"><span>${l.action} by ${l.by}</span><span class="text-xs">${l.timestamp}</span></div>`).join('') || '<p>No logs.</p>';
      } catch { App.toast('Load failed', 'error'); }
    },
    downloadAuditReport: () => { /* Generate PDF or download logs */ App.toast('Report downloaded', 'success'); },
    renderCommitteeDash: async () => {
      // Load queues for notes
      await Promise.all([App.loadWelfare(), App.loadNews(), App.renderPendingLoans()]); // Reuse
      document.getElementById('cm-welfare-view').innerHTML = App.data.welfare.map(w => `<div>${w.member}: ${w.type}</div>`).join('');
      document.getElementById('cm-news-view').innerHTML = App.data.news.slice(-3).map(n => `<div>${n.text.substring(0,50)}...</div>`).join('');
      document.getElementById('cm-fin-report-view').innerHTML = App.data.loans.filter(l => l.status === 'Pending').map(l => `<div>${l.member}: KES ${l.amount}</div>`).join('');
    },
    addCommitteeNote: async (type) => {
      const note = document.getElementById(`cm-${type}-note`).value;
      if (!note) return App.toast('Enter note', 'error');
      try {
        await App.fetchWithAuth('/chair-queue', { method: 'POST', body: JSON.stringify({ type: `${type} Note`, data: { note }, author: App.data.user }) });
        App.toast('Note added', 'success');
        document.getElementById(`cm-${type}-note`).value = '';
        App.renderCommitteeDash();
      } catch {}
    },
    downloadResults: () => { /* Export polls to PDF */ App.toast('Results downloaded', 'success'); },
    toggleEditProfile: () => {
      const inputs = document.querySelectorAll('#view-profile input:not(#new-pin)');
      inputs.forEach(input => input.disabled = !input.disabled);
      document.getElementById('save-profile-btn').classList.toggle('hidden');
      document.getElementById('edit-profile-btn').classList.toggle('hidden');
    },
    saveProfile: async () => {
      const name = document.getElementById('profile-name').value;
      const email = document.getElementById('profile-email').value;
      App.showSpinner('save-spinner');
      try {
        await App.fetchWithAuth(`/members/${email}`, { method: 'PUT', body: JSON.stringify({ name }) });
        App.toast('Profile saved', 'success');
        App.data.user = name;
        document.getElementById('welcome-user').textContent = name;
      } catch {}
      finally { App.showSpinner('save-spinner', false); }
    },
    changePin: async () => {
      const newPin = document.getElementById('new-pin').value;
      if (newPin.length !== 4) return App.toast('4 digits', 'error');
      App.showSpinner('pin-spinner');
      try {
        await App.fetchWithAuth(`/members/${App.data.user}`, { method: 'PUT', body: JSON.stringify({ newPin }) }); // Use email from token
        App.toast('PIN updated', 'success');
        document.getElementById('new-pin').value = '';
      } catch {}
      finally { App.showSpinner('pin-spinner', false); }
    },
    logout: () => {
      localStorage.removeItem('token');
      userToken = '';
      document.getElementById('portal-member').classList.add('hidden');
      document.getElementById('portal-admin').classList.add('hidden');
      document.getElementById('screen-auth').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
      deferredPrompt = null; // Reset install
    },
    verifyPin: () => { /* For general PIN modals */ App.memberLogin(); } // Reuse
  };
  // Event Listeners
  document.addEventListener('keydown', (e) => { if (e.key === 'Enter' && (document.activeElement.id.includes('pin') || document.activeElement.id.includes('login'))) App.memberLogin(); });
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(() => {});
  window.onload = () => {
    setTimeout(() => document.getElementById('splash-screen').classList.add('opacity-0', 'pointer-events-none'), 1500);
    setTimeout(() => {
      document.getElementById('splash-screen').classList.add('hidden');
      if (userToken) App.memberLogin(); // Auto-login if token
    }, 2200);
  };
</script>
