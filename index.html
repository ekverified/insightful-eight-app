<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Insightful Eight Ltd | v1.0.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            brand: { 500: '#6366f1', 600: '#4f46e5', 900: '#312e81' },
            dark: { 950: '#020617', 900: '#0f172a', 800: '#1e293b' }
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out forwards',
            'slide-up': 'slideUp 0.3s ease-out forwards',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
          }
        }
      }
    }
  </script>
  <style>
    body { background-color: #020617; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
    .glass { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
    .modal-glass { background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); }
    .hide-scroll::-webkit-scrollbar { display: none; }
    .nav-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
    .nav-item.active { background: rgba(99, 102, 241, 0.1); color: #818cf8; border-left-color: #6366f1; }
    .welfare-step.active { color: #10b981; font-weight: bold; }
    .welfare-step.pending { color: #64748b; }
    .loading { opacity: 0.6; pointer-events: none; }
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #6366f1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body class="flex h-screen overflow-hidden select-none bg-dark-950 font-sans">
  <div id="splash-screen" class="fixed inset-0 z-[100] bg-dark-950 flex flex-col items-center justify-center transition-opacity duration-700">
    <div class="w-20 h-20 rounded-2xl bg-gradient-to-tr from-brand-600 to-indigo-400 flex items-center justify-center text-white font-bold text-4xl mb-6 shadow-2xl shadow-brand-500/20">i8</div>
    <p class="text-white text-lg font-bold">Insightful Eight Ltd</p>
    <p class="text-slate-500 text-xs font-bold uppercase tracking-[0.2em] mt-2 animate-pulse">Loading System v6.0</p>
  </div>

  <div id="screen-auth" class="fixed inset-0 z-[60] bg-dark-950 flex flex-col items-center justify-center p-6 transition-all duration-500">
    <div class="w-16 h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white font-bold text-2xl mb-6">i8</div>
    <h1 class="text-2xl font-bold text-white mb-2">Member Login</h1>
    <p class="text-slate-500 text-sm mb-8">Insightful Eight Ltd</p>
    <div class="w-full max-w-xs space-y-4">
      <input type="email" id="login-email" placeholder="Email" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white" aria-label="Email">
      <input type="password" id="member-pin" maxlength="4" class="w-full bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-4 outline-none focus:border-brand-500 transition placeholder-slate-700" placeholder="••••" aria-label="PIN">
      <button onclick="App.memberLogin()" class="w-full bg-brand-600 text-white font-bold py-3.5 rounded-xl hover:bg-brand-500 transition shadow-lg" aria-label="Login"><span id="login-spinner" class="spinner hidden"></span>Access Portal</button>
      <button onclick="App.resetPin()" class="w-full text-slate-500 text-xs hover:text-white" aria-label="Reset PIN">Forgot PIN? Reset</button>
      <p class="text-center text-xs text-slate-600 mt-6">Demo: felix@example.com / 1234</p>
      <button onclick="App.showRegister()" class="w-full text-slate-500 text-xs mt-2 hover:text-white" aria-label="Register">New Member? Register Here</button>
    </div>
  </div>

  <div id="screen-register" class="hidden fixed inset-0 z-[60] bg-dark-950 flex flex-col items-center justify-center p-6 transition-all duration-500">
    <div class="w-16 h-16 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white font-bold text-2xl mb-6">i8</div>
    <h1 class="text-2xl font-bold text-white mb-2">New Member Registration</h1>
    <p class="text-slate-500 text-sm mb-8">Match your details and set PIN</p>
    <div class="w-full max-w-xs space-y-4">
      <input type="text" id="reg-name" placeholder="Full Name" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white" aria-label="Full Name">
      <input type="email" id="reg-email" placeholder="Email" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white" aria-label="Email">
      <input type="password" id="reg-pin" maxlength="4" class="w-full bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-3" placeholder="••••" aria-label="PIN">
      <button onclick="App.registerMember()" class="w-full bg-brand-600 text-white font-bold py-3.5 rounded-xl hover:bg-brand-500 transition shadow-lg" aria-label="Register"><span id="reg-spinner" class="spinner hidden"></span>Register</button>
      <button onclick="App.showLogin()" class="w-full text-slate-500 text-sm py-2" aria-label="Back to Login">Back to Login</button>
    </div>
  </div>

  <div id="toast-box" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[200] flex flex-col gap-3 w-full max-w-sm px-4 pointer-events-none"></div>

  <div id="portal-member" class="hidden flex w-full h-full transition-all duration-500 transform scale-100 opacity-100 origin-center">
    <aside class="hidden md:flex flex-col w-72 bg-dark-950/50 backdrop-blur-xl border-r border-dark-800 z-20">
      <div class="h-24 flex items-center px-8 border-b border-white/5">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-600 to-indigo-400 flex items-center justify-center text-white font-bold text-xl mr-3 shadow-lg shadow-brand-500/20">i8</div>
        <div><h1 class="font-bold text-lg text-white tracking-tight">Insightful 8</h1><p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Portal</p></div>
      </div>
      <nav class="flex-1 px-4 py-6 space-y-1">
        <button onclick="App.nav('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5" aria-label="Dashboard"><i class="fa-solid fa-grid-2 w-5"></i> Dashboard</button>
        <button onclick="App.nav('finance')" id="nav-finance" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5" aria-label="Finance"><i class="fa-solid fa-wallet w-5"></i> Finance & Loans</button>
        <button onclick="App.nav('welfare')" id="nav-welfare" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5" aria-label="Welfare"><i class="fa-solid fa-hand-holding-heart w-5"></i> Welfare</button>
        <button onclick="App.nav('vote')" id="nav-vote" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5" aria-label="Elections"><i class="fa-solid fa-check-to-slot w-5"></i> Elections</button>
        <button onclick="App.nav('profile')" id="nav-profile" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-slate-400 font-medium hover:text-white hover:bg-white/5" aria-label="Profile"><i class="fa-solid fa-user w-5"></i> Profile</button>
        <div id="admin-switch-container" class="mt-auto border-t border-white/5 pt-4 hidden">
          <button onclick="App.switchContext('admin')" class="w-full flex items-center gap-3 px-4 py-3.5 rounded-r-xl text-amber-500 font-medium hover:bg-amber-500/10 border-l-4 border-transparent hover:border-amber-500 transition group" aria-label="Admin"><i class="fa-solid fa-shield-halved w-5 group-hover:scale-110 transition"></i> Executive Admin</button>
        </div>
        <div class="mt-4">
          <button onclick="App.logout()" class="w-full text-red-400 text-xs font-bold py-2 hover:text-red-300" aria-label="Logout">Logout</button>
        </div>
      </nav>
    </aside>

    <main class="flex-1 flex flex-col relative h-full bg-gradient-to-br from-dark-950 via-dark-900 to-dark-950">
      <header class="md:hidden h-16 flex items-center justify-between px-5 bg-dark-950/80 backdrop-blur border-b border-white/5 sticky top-0 z-30">
        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-brand-600 flex items-center justify-center text-white font-bold">i8</div><span id="header-title" class="font-bold text-lg text-white">Dashboard</span></div>
        <div class="flex items-center gap-2">
          <button id="mobile-admin-btn" onclick="App.switchContext('admin')" class="text-amber-500 text-xs font-bold uppercase border border-amber-500/30 px-3 py-1.5 rounded-lg active:bg-amber-500/10 hidden" aria-label="Admin">Admin</button>
          <button onclick="App.logout()" class="text-red-400 text-xs font-bold uppercase border border-red-400/30 px-3 py-1.5 rounded-lg active:bg-red-400/10" aria-label="Logout">Logout</button>
        </div>
      </header>

      <div id="member-view-container" class="flex-1 overflow-y-auto hide-scroll p-5 pb-32 md:p-10">
        <section id="view-dashboard" class="space-y-8 animate-slide-up max-w-6xl mx-auto">
          <div class="flex justify-between items-end">
            <div><h2 class="text-3xl font-bold text-white tracking-tight">Insightful Eight Ltd</h2><p class="text-sm text-slate-400 mt-1">Welcome back, <span id="welcome-user"></span>.</p></div>
          </div>
          <button onclick="App.toggleNotifications()" class="absolute top-6 right-6 text-white bg-white/10 p-2 rounded-full hover:bg-white/20" aria-label="Notifications"><i class="fa-solid fa-bell"></i><span id="notif-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span></button>
          <div id="notifications-panel" class="hidden glass p-4 rounded-xl absolute top-16 right-6 z-10 space-y-2 w-80">
            <h4 class="font-bold text-white">Personal Notifications</h4>
            <div id="notif-list"></div>
          </div>

          <div class="glass p-6 rounded-2xl border-l-4 border-l-brand-500">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="fa-solid fa-bullhorn text-brand-400"></i> Official Communications</h3><span class="text-[10px] text-slate-500">Verified by Chair</span></div>
            <div id="member-news-feed" class="space-y-4"></div>
          </div>

          <div class="glass p-6 rounded-2xl border-l-4 border-l-emerald-400">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="fa-solid fa-chart-line text-emerald-400"></i> Approved Financial Reports</h3><span class="text-[10px] text-slate-500">Chair Verified</span></div>
            <div id="approved-reports" class="space-y-4"></div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass p-6 rounded-2xl"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Company Liquidity</p><h3 id="dash-liquidity" class="text-3xl font-bold text-white mt-1">KES 0</h3></div>
            <div class="glass p-6 rounded-2xl cursor-pointer hover:bg-white/5" onclick="App.nav('vote')" aria-label="Active Polls"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Active Polls</p><h3 id="dash-poll-count" class="text-3xl font-bold text-white mt-1">0</h3></div>
            <div class="glass p-6 rounded-2xl border-l-4 border-l-emerald-500"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider">My Welfare Status</p><h3 id="dash-welfare-status" class="text-xl font-bold text-white mt-1">Good Standing</h3></div>
          </div>
        </section>

        <section id="view-finance" class="hidden space-y-6 animate-slide-up max-w-4xl mx-auto">
          <h2 class="text-2xl font-bold text-white">Finance & Business Loans</h2>
          <div class="flex gap-2 mb-4">
            <button onclick="App.uploadSlip()" class="flex-1 bg-white text-dark-950 py-3 rounded-xl font-bold hover:bg-slate-200" aria-label="Record Payment"><i class="fa-solid fa-receipt mr-2"></i>Record Pay</button>
            <button onclick="App.openLoanModal()" class="flex-1 bg-dark-800 border border-white/10 text-white py-3 rounded-xl font-bold hover:bg-dark-700" aria-label="Apply Loan"><i class="fa-solid fa-money-bill-transfer mr-2"></i>Apply Loan</button>
          </div>
          <div class="glass rounded-2xl overflow-hidden border border-white/5">
            <div class="p-4 bg-white/5 border-b border-white/5"><span class="text-xs font-bold text-slate-300">Transaction Ledger</span></div>
            <div id="finance-list" class="divide-y divide-white/5"></div>
          </div>
        </section>

        <section id="view-welfare" class="hidden space-y-6 animate-slide-up max-w-4xl mx-auto">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-white">Welfare Support</h2>
            <button onclick="App.openWelfareModal()" class="bg-pink-600 hover:bg-pink-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-pink-500/20" aria-label="Claim Support"><i class="fa-solid fa-heart-pulse mr-2"></i>Claim Support</button>
          </div>
          <div class="glass p-6 rounded-2xl border border-pink-500/20">
            <p class="text-sm text-slate-400 mb-6">Welfare is support, not a loan. All claims undergo the 3-Step Verification process.</p>
            <div id="welfare-list" class="space-y-4"></div>
          </div>
        </section>

        <section id="view-vote" class="hidden space-y-6 animate-slide-up max-w-3xl mx-auto">
          <div class="flex justify-between items-center">
            <h2 class="text-2xl font-bold text-white">Polls & Elections</h2>
            <button onclick="App.downloadResults()" class="hidden id-download-btn text-xs bg-dark-800 border border-white/10 text-white px-3 py-2 rounded-lg hover:bg-dark-700" aria-label="Download Results"><i class="fa-solid fa-download mr-1"></i> Official Results</button>
          </div>
          <div id="polls-container" class="space-y-6"></div>
        </section>

        <section id="view-profile" class="hidden space-y-6 animate-slide-up max-w-4xl mx-auto">
          <h2 class="text-2xl font-bold text-white">Profile</h2>
          <button id="edit-profile-btn" onclick="App.toggleEditProfile()" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold mb-4" aria-label="Edit Profile">Edit Profile</button>
          <div class="glass p-6 rounded-2xl">
            <div class="space-y-4">
              <div><label class="text-xs text-slate-400 uppercase font-bold">Full Name</label><input type="text" id="profile-name" value="" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1" disabled aria-label="Name"></div>
              <div><label class="text-xs text-slate-400 uppercase font-bold">Email</label><input type="email" id="profile-email" value="" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1" disabled aria-label="Email"></div>
              <div><label class="text-xs text-slate-400 uppercase font-bold">Change PIN</label><input type="password" id="new-pin" maxlength="4" class="w-full bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-3 mt-1" placeholder="••••" aria-label="New PIN"><button onclick="App.changePin()" class="mt-2 bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold" aria-label="Update PIN"><span id="pin-spinner" class="spinner hidden"></span>Update PIN</button></div>
              <button id="save-profile-btn" onclick="App.saveProfile()" class="hidden w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-500 mt-4" aria-label="Save Changes"><span id="save-spinner" class="spinner hidden"></span>Save Changes</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div id="modal-welfare" class="hidden absolute inset-0 z-50 bg-dark-950/90 backdrop-blur flex items-center justify-center p-4">
      <div class="glass p-6 rounded-2xl w-full max-w-md animate-slide-up border border-pink-500/30">
        <h3 class="text-xl font-bold text-white mb-4">New Welfare Claim</h3>
        <div class="space-y-4">
          <div><label class="text-xs text-slate-400 uppercase font-bold">Nature of Issue</label><select id="welfare-type" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1" aria-label="Issue Type"><option>Medical Emergency</option><option>Bereavement</option><option>Social Support</option></select></div>
          <div><label class="text-xs text-slate-400 uppercase font-bold">Amount Required (KES)</label><input type="number" id="welfare-amount" min="1" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1" aria-label="Amount"></div>
          <button onclick="App.submitWelfare()" class="w-full bg-pink-600 text-white font-bold py-3 rounded-xl hover:bg-pink-500" aria-label="Submit Claim"><span id="welfare-spinner" class="spinner hidden"></span>Submit to Secretary</button>
          <button onclick="document.getElementById('modal-welfare').classList.add('hidden')" class="w-full text-slate-500 text-sm py-2" aria-label="Cancel">Cancel</button>
        </div>
      </div>
    </div>

    <div id="modal-loan" class="hidden absolute inset-0 z-50 bg-dark-950/90 backdrop-blur flex items-center justify-center p-4">
      <div class="glass p-6 rounded-2xl w-full max-w-md animate-slide-up border border-emerald-500/30">
        <h3 class="text-xl font-bold text-white mb-4">Loan Application</h3>
        <div class="space-y-4">
          <div><label class="text-xs text-slate-400 uppercase font-bold">Amount (KES)</label><input type="number" id="loan-amount" min="1" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1" aria-label="Loan Amount"></div>
          <div><label class="text-xs text-slate-400 uppercase font-bold">Purpose</label><textarea id="loan-purpose" class="w-full bg-dark-900 border border-white/10 rounded-xl p-3 text-white mt-1 h-20" aria-label="Purpose"></textarea></div>
          <button onclick="App.submitLoan()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-500" aria-label="Apply Loan"><span id="loan-spinner" class="spinner hidden"></span>Apply</button>
          <button onclick="document.getElementById('modal-loan').classList.add('hidden')" class="w-full text-slate-500 text-sm py-2" aria-label="Cancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div id="portal-admin" class="hidden fixed inset-0 z-50 bg-dark-950 flex flex-col transition-all duration-300 transform opacity-0 scale-95">
    <header class="h-16 border-b border-white/5 bg-dark-900 flex items-center justify-between px-6 shadow-2xl">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-amber-500 text-dark-950 flex items-center justify-center font-bold"><i class="fa-solid fa-shield-halved"></i></div>
        <span class="font-bold text-lg text-white">i-8 Admin <span id="admin-badge" class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-slate-400 ml-2 uppercase">Locked</span></span>
      </div>
      <button onclick="App.adminLogout()" class="text-xs font-bold text-red-400 hover:text-red-300 uppercase border border-red-500/20 px-4 py-2 rounded-lg hover:bg-red-500/10 transition" aria-label="Admin Logout"><i class="fa-solid fa-power-off mr-1"></i> Secure Exit</button>
    </header>
    <main class="flex-1 relative overflow-hidden bg-gradient-to-br from-dark-950 via-[#0f1221] to-dark-950 p-6 md:p-10 overflow-y-auto">

      <div id="admin-screen-login" class="flex flex-col items-center justify-center h-full">
        <h2 class="text-2xl font-bold text-white mb-8">Select Role</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-4xl">
          <button onclick="App.adminLogin('secretary')" class="glass p-6 rounded-xl hover:bg-blue-500/10 border-l-4 border-blue-500 text-left group" aria-label="Secretary"><div class="text-blue-400 text-xl mb-2"><i class="fa-solid fa-pen-nib"></i></div><h3 class="font-bold text-white group-hover:translate-x-1 transition">Secretary</h3><p class="text-xs text-slate-500 mt-1">Polls, Welfare Recording, Minutes</p></button>
          <button onclick="App.adminLogin('treasurer')" class="glass p-6 rounded-xl hover:bg-emerald-500/10 border-l-4 border-emerald-500 text-left group" aria-label="Treasurer"><div class="text-emerald-400 text-xl mb-2"><i class="fa-solid fa-coins"></i></div><h3 class="font-bold text-white group-hover:translate-x-1 transition">Treasurer</h3><p class="text-xs text-slate-500 mt-1">Loans, Welfare Funding, Payments</p></button>
          <button onclick="App.adminLogin('chairperson')" class="glass p-6 rounded-xl hover:bg-purple-500/10 border-l-4 border-purple-500 text-left group" aria-label="Chairperson"><div class="text-purple-400 text-xl mb-2"><i class="fa-solid fa-gavel"></i></div><h3 class="font-bold text-white group-hover:translate-x-1 transition">Chairperson</h3><p class="text-xs text-slate-500 mt-1">Final Approvals, Signatory</p></button>
          <button onclick="App.adminLogin('supervisorycommittee')" class="glass p-6 rounded-xl hover:bg-gray-500/10 border-l-4 border-gray-500 text-left group" aria-label="Supervisory Committee"><div class="text-gray-400 text-xl mb-2"><i class="fa-solid fa-eye"></i></div><h3 class="font-bold text-white group-hover:translate-x-1 transition">Supervisory Committee</h3><p class="text-xs text-slate-500 mt-1">Compliance Oversight, Audits, Monitoring</p></button>
          <button onclick="App.adminLogin('committeemember')" class="glass p-6 rounded-xl hover:bg-orange-500/10 border-l-4 border-orange-500 text-left group" aria-label="Committee Member"><div class="text-orange-400 text-xl mb-2"><i class="fa-solid fa-users"></i></div><h3 class="font-bold text-white group-hover:translate-x-1 transition">Committee Member</h3><p class="text-xs text-slate-500 mt-1">Participate in All Admin Functions</p></button>
        </div>
      </div>

      <div id="view-admin-secretary" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="bg-blue-900/20 border border-blue-500/30 p-6 rounded-2xl">
          <h3 class="font-bold text-white mb-4">Create New Poll</h3>
          <input id="poll-question" type="text" placeholder="Poll Question (e.g. Venue for AGM?)" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white mb-3" aria-label="Poll Question">
          <input id="poll-opts" type="text" placeholder="Options (comma separated: Naivasha, Nakuru)" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white mb-3" aria-label="Poll Options">
          <button onclick="App.createPoll()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-500 mr-2" aria-label="Launch Poll"><span id="poll-spinner" class="spinner hidden"></span>Launch Poll</button>
          <button onclick="App.closePoll()" class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-500" aria-label="Close Poll">Close Poll</button>
        </div>
        <!-- Other secretary sections (welfare queue, news draft, member management, handover) as in original, with spinners/ARIA -->
        <div class="glass p-6 rounded-2xl mt-8"><h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Secretary)</h3><div class="flex gap-4"><input type="text" id="handover-name-sec" placeholder="New Secretary Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="New Secretary Name"><select id="handover-sig-sec" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="Signature"><option value="">Select Signature</option></select><button onclick="App.executeHandover('secretary')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition" aria-label="Execute Handover">Execute</button></div></div>
      </div>

      <div id="view-admin-treasurer" class="hidden space-y-6 max-w-4xl mx-auto">
        <!-- Treasurer content with spinners/ARIA, similar to original -->
        <div class="glass p-6 rounded-2xl mt-8"><h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Treasurer)</h3><div class="flex gap-4"><input type="text" id="handover-name-treas" placeholder="New Treasurer Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="New Treasurer Name"><select id="handover-sig-treas" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="Signature"><option value="">Select Signature</option></select><button onclick="App.executeHandover('treasurer')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition" aria-label="Execute Handover">Execute</button></div></div>
      </div>

      <div id="view-admin-chairperson" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="bg-purple-900/20 border border-purple-500/30 p-6 rounded-2xl relative overflow-hidden">
          <div class="absolute -right-4 -top-4 text-purple-500/10 text-9xl"><i class="fa-solid fa-stamp"></i></div>
          <h3 class="font-bold text-white text-xl mb-1">The Chairman's Gate</h3>
          <p class="text-sm text-purple-300 mb-6">Review, Authenticate & Sign off on pending items.</p>
          <div id="chair-queue" class="space-y-3 relative z-10"></div>
        </div>
        <div class="glass p-6 rounded-2xl">
          <h3 class="font-bold text-white mb-4">Promote Member to Admin Role</h3>
          <div class="space-y-2">
            <input id="promote-email" placeholder="Member Email" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="Promote Email">
            <select id="promote-role" class="w-full bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="Promote Role"><option value="">Select Role</option><option value="secretary">Secretary</option><option value="treasurer">Treasurer</option><option value="supervisorycommittee">Supervisory Committee</option><option value="committeemember">Committee Member</option></select>
            <button onclick="App.promoteMember()" class="w-full bg-purple-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-purple-500 mt-2" aria-label="Promote"><span id="promote-spinner" class="spinner hidden"></span>Promote</button>
          </div>
        </div>
        <div class="glass p-6 rounded-2xl mt-8"><h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Chairperson)</h3><div class="flex gap-4"><input type="text" id="handover-name-chair" placeholder="New Chairperson Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="New Chairperson Name"><select id="handover-sig-chair" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="Signature"><option value="">Select Signature</option></select><button onclick="App.executeHandover('chairperson')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition" aria-label="Execute Handover">Execute</button></div></div>
        <div class="glass p-6 rounded-2xl mt-8"><h3 class="font-bold text-white mb-4"><i class="fa-solid fa-chart-pie mr-2 text-purple-400"></i>Analytics Overview</h3><div class="h-64"><canvas id="analytics-chart"></canvas></div></div>
      </div>

      <div id="view-admin-supervisorycommittee" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="glass p-6 rounded-2xl border-l-4 border-gray-500">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-white">Audit & Compliance Monitoring</h3>
            <button onclick="App.downloadAuditReport()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-gray-500/20" aria-label="Download Audit"><i class="fa-solid fa-download mr-2"></i>Download Audit Report</button>
          </div>
          <p class="text-sm text-slate-400 mb-6">View all logged actions by Executive Committee for compliance review, risk assessment, and audit preparation. No modifications allowed.</p>
          <div id="supervisory-logs" class="space-y-3 max-h-96 overflow-y-auto hide-scroll divide-y divide-white/5"><p class="text-slate-500 text-sm italic">Loading audit logs...</p></div>
        </div>
        <div class="glass p-6 rounded-2xl mt-8"><h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Supervisory Committee)</h3><div class="flex gap-4"><input type="text" id="handover-name-sup" placeholder="New Supervisory Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="New Supervisory Name"><select id="handover-sig-sup" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="Signature"><option value="">Select Signature</option></select><button onclick="App.executeHandover('supervisorycommittee')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition" aria-label="Execute Handover">Execute</button></div></div>
      </div>

      <div id="view-admin-committeemember" class="hidden space-y-6 max-w-4xl mx-auto">
        <div class="glass p-6 rounded-2xl border-l-4 border-orange-500">
          <h3 class="font-bold text-white mb-4">Committee Participation Dashboard</h3>
          <p class="text-sm text-slate-400 mb-6">View and participate in all admin functions. Add notes to queues for discussion.</p>
          <div class="space-y-4">
            <div><h4 class="font-bold text-orange-400 mb-2">Welfare Queue</h4><div id="cm-welfare-view" class="space-y-2 bg-dark-900 p-3 rounded-lg"></div><textarea id="cm-welfare-note" class="w-full bg-dark-950 border border-white/10 rounded-xl p-2 text-white text-sm" placeholder="Add note..." aria-label="Welfare Note"></textarea><button onclick="App.addCommitteeNote('welfare')" class="bg-orange-600 text-white px-4 py-1 rounded text-xs" aria-label="Submit Welfare Note">Submit Note to Chair</button></div>
            <div><h4 class="font-bold text-orange-400 mb-2">News Queue</h4><div id="cm-news-view" class="space-y-2 bg-dark-900 p-3 rounded-lg"></div><textarea id="cm-news-note" class="w-full bg-dark-950 border border-white/10 rounded-xl p-2 text-white text-sm" placeholder="Add note..." aria-label="News Note"></textarea><button onclick="App.addCommitteeNote('news')" class="bg-orange-600 text-white px-4 py-1 rounded text-xs" aria-label="Submit News Note">Submit Note to Chair</button></div>
            <div><h4 class="font-bold text-orange-400 mb-2">Financial Reports Queue</h4><div id="cm-fin-report-view" class="space-y-2 bg-dark-900 p-3 rounded-lg"></div><textarea id="cm-fin-note" class="w-full bg-dark-950 border border-white/10 rounded-xl p-2 text-white text-sm" placeholder="Add note..." aria-label="Financial Note"></textarea><button onclick="App.addCommitteeNote('fin')" class="bg-orange-600 text-white px-4 py-1 rounded text-xs" aria-label="Submit Financial Note">Submit Note to Chair</button></div>
          </div>
        </div>
        <div class="glass p-6 rounded-2xl mt-8"><h3 class="font-bold text-white mb-4 text-red-400"><i class="fa-solid fa-user-gear mr-2"></i>Handover/Takeover (Committee Member)</h3><div class="flex gap-4"><input type="text" id="handover-name-cm" placeholder="New Committee Member Name" class="flex-1 bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="New Committee Member Name"><select id="handover-sig-cm" class="bg-dark-950 border border-white/10 rounded-xl p-3 text-white" aria-label="Signature"><option value="">Select Signature</option></select><button onclick="App.executeHandover('committeemember')" class="bg-red-500/20 text-red-400 border border-red-500/30 px-4 rounded-xl font-bold text-xs hover:bg-red-500 hover:text-white transition" aria-label="Execute Handover">Execute</button></div></div>
      </div>
    </main>
  </div>

  <div id="modal-pin" class="hidden absolute inset-0 z-[70] bg-dark-950/90 backdrop-blur flex items-center justify-center">
    <div class="glass p-8 rounded-2xl w-full max-w-xs text-center">
      <h3 id="pin-title" class="text-xl font-bold text-white mb-2">Enter PIN</h3>
      <input type="password" id="pin-input" maxlength="4" class="bg-dark-900 border border-white/10 rounded-xl text-center text-2xl tracking-[1em] text-white p-3 w-full outline-none focus:border-brand-500 transition mb-4" aria-label="PIN">
      <button onclick="App.verifyPin()" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-500" aria-label="Unlock">Unlock Console</button>
      <button onclick="document.getElementById('modal-pin').classList.add('hidden')" class="mt-4 text-xs text-slate-500 hover:text-white" aria-label="Cancel">Cancel</button>
    </div>
  </div>

  <script>
    const API_BASE = 'https://app-backend-xil0.onrender.com'; // Update if redeployed
    let userToken = localStorage.getItem('token') || '';
    let currentUserRole = 'member';
    const App = {
      data: {
        user: '',
        role: 'member',
        news: [],
        polls: [],
        approvedReports: [],
        welfare: [],
        chairQueue: [],
        transactions: [],
        logs: [],
        members: [],
        signatures: {},
        notifications: [],
        loans: []
      },

      // Utils
      showSpinner: (id, show = true) => {
        if (id) document.getElementById(id)?.classList.toggle('hidden', !show);
        document.body.classList.toggle('loading', show);
      },

      toast: (msg, type = 'info') => {
        const toast = document.createElement('div');
        toast.className = `p-3 rounded-lg ${type === 'error' ? 'bg-red-500/20 border-red-500/30 text-red-300' : type === 'success' ? 'bg-green-500/20 border-green-500/30 text-green-300' : 'bg-blue-500/20 border-blue-500/30 text-blue-300'} border animate-fade-in`;
        toast.textContent = msg;
        toast.setAttribute('role', 'alert');
        document.getElementById('toast-box').appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      },

      fetchWithAuth: async (endpoint, options = {}) => {
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (userToken) headers.Authorization = `Bearer ${userToken}`;
        try {
          const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Request failed');
          }
          return await res.json();
        } catch (err) {
          // Enhancement: Offline fallback toast
          if (!navigator.onLine) App.toast('Offline: Using cached data', 'info');
          throw err;
        }
      },

      // Auth & Nav
      memberLogin: async () => {
        const email = document.getElementById('login-email').value.trim();
        const pin = document.getElementById('member-pin').value;
        if (!email || !pin || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return App.toast('Valid email and 4-digit PIN required', 'error'); // Enhancement: Email regex
        App.showSpinner('login-spinner');
        try {
          const data = await App.fetchWithAuth('/auth', { method: 'POST', body: JSON.stringify({ email, pin }) });
          App.data.user = data.user.name;
          currentUserRole = data.user.role;
          localStorage.setItem('token', data.token);
          userToken = data.token;
          document.getElementById('screen-auth').classList.add('opacity-0', 'pointer-events-none');
          setTimeout(() => {
            document.getElementById('screen-auth').classList.add('hidden');
            document.getElementById('portal-member').classList.remove('hidden');
            document.getElementById('welcome-user').innerText = App.data.user;
            // Show admin if role allows
            const adminContainer = document.getElementById('admin-switch-container');
            const mobileBtn = document.getElementById('mobile-admin-btn');
            if (['secretary', 'treasurer', 'chairperson', 'supervisorycommittee', 'committeemember'].includes(currentUserRole)) {
              adminContainer.classList.remove('hidden');
              mobileBtn.classList.remove('hidden');
            } else {
              adminContainer.classList.add('hidden');
              mobileBtn.classList.add('hidden');
            }
            App.renderAll();
            App.renderNotifications();
          }, 500);
        } catch (err) {
          App.toast(err.message || 'Login failed', 'error');
        } finally {
          App.showSpinner('login-spinner', false);
          if (document.getElementById('login-email').value) document.getElementById('login-email').value = '';
          document.getElementById('member-pin').value = '';
        }
      },

      resetPin: async () => {
        const email = document.getElementById('login-email').value.trim();
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return App.toast('Enter valid email', 'error');
        try {
          const data = await fetch(`${API_BASE}/reset-pin`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) }).then(r => r.json());
          App.toast(data.message, 'success');
        } catch (err) {
          App.toast(err.message || 'Reset failed', 'error');
        }
      },

      showRegister: () => {
        document.getElementById('screen-auth').classList.add('hidden');
        document.getElementById('screen-register').classList.remove('hidden');
      },

      showLogin: () => {
        document.getElementById('screen-register').classList.add('hidden');
        document.getElementById('screen-auth').classList.remove('hidden');
      },

      registerMember: async () => {
        const name = document.getElementById('reg-name').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const pin = document.getElementById('reg-pin').value;
        if (!name || !email || !pin || pin.length !== 4 || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) || name.length < 2) return App.toast('Valid name (2+ chars), email, and 4-digit PIN required', 'error');
        App.showSpinner('reg-spinner');
        try {
          const res = await fetch(`${API_BASE}/members`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email, pin }) });
          if (res.ok) {
            App.toast('Registration Successful! Use your email and PIN to login.', 'success');
            App.showLogin();
            document.getElementById('reg-name').value = '';
            document.getElementById('reg-email').value = '';
            document.getElementById('reg-pin').value = '';
          } else {
            const errData = await res.json();
            throw new Error(errData.error || 'Registration failed');
          }
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('reg-spinner', false);
        }
      },

      logout: async () => {
        try {
          await fetch(`${API_BASE}/logout`, { method: 'POST', headers: { 'Authorization': `Bearer ${userToken}` } });
        } catch {} // Ignore errors
        localStorage.removeItem('token');
        userToken = '';
        currentUserRole = 'member';
        document.getElementById('portal-member').classList.add('hidden');
        document.getElementById('portal-admin')?.classList.add('hidden');
        document.getElementById('screen-auth').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
        document.getElementById('admin-switch-container').classList.add('hidden');
        document.getElementById('mobile-admin-btn').classList.add('hidden');
        App.data = { user: '', role: 'member', news: [], polls: [], approvedReports: [], welfare: [], chairQueue: [], transactions: [], logs: [], members: [], signatures: {}, notifications: [], loans: [] };
      },

      nav: (view) => {
        document.querySelectorAll('#member-view-container section').forEach(el => el.classList.add('hidden'));
        const target = document.getElementById(`view-${view}`);
        target.classList.remove('hidden');
        target.classList.remove('animate-slide-up');
        void target.offsetWidth;
        target.classList.add('animate-slide-up');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-${view}`).classList.add('active');
        document.getElementById('header-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
      },

      switchContext: (ctx) => {
        if (ctx === 'admin' && !['secretary', 'treasurer', 'chairperson', 'supervisorycommittee', 'committeemember'].includes(currentUserRole)) return App.toast('Admin access denied', 'error');
        if (ctx === 'admin') {
          const admin = document.getElementById('portal-admin');
          const member = document.getElementById('portal-member');
          member.classList.add('hidden');
          admin.classList.remove('hidden');
          setTimeout(() => admin.classList.remove('opacity-0', 'scale-95'), 50);
          const roleKey = currentUserRole.replace(/([A-Z])/g, ' $1').trim().toLowerCase();
          const roleBtn = document.querySelector(`[onclick="App.adminLogin('${currentUserRole}')"]`);
          if (roleBtn) roleBtn.click();
        }
      },

      // Profile
      toggleEditProfile: () => {
        const inputs = document.querySelectorAll('#view-profile input:not(#new-pin)');
        const btn = document.getElementById('edit-profile-btn');
        const saveBtn = document.getElementById('save-profile-btn');
        const isEditing = btn.textContent === 'Cancel Edit';
        inputs.forEach(input => input.disabled = isEditing);
        btn.textContent = isEditing ? 'Edit Profile' : 'Cancel Edit';
        saveBtn.classList.toggle('hidden', isEditing);
        if (isEditing) document.getElementById('new-pin').value = '';
      },

      saveProfile: async () => {
        const name = document.getElementById('profile-name').value.trim();
        const email = document.getElementById('profile-email').value.trim();
        const newPin = document.getElementById('new-pin').value;
        if (!name || !email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return App.toast('Valid name and email required', 'error');
        App.showSpinner('save-spinner');
        try {
          await App.fetchWithAuth(`/members/${email}`, { method: 'PUT', body: JSON.stringify({ name, ...(newPin && { newPin }) }) });
          App.toast('Profile updated successfully', 'success');
          App.toggleEditProfile();
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('save-spinner', false);
        }
      },

      changePin: async () => {
        const newPin = document.getElementById('new-pin').value;
        if (newPin.length !== 4) return App.toast('PIN must be 4 digits', 'error');
        App.showSpinner('pin-spinner');
        try {
          const email = document.getElementById('profile-email').value;
          await App.fetchWithAuth(`/members/${email}`, { method: 'PUT', body: JSON.stringify({ newPin }) });
          App.toast('PIN updated successfully', 'success');
          document.getElementById('new-pin').value = '';
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('pin-spinner', false);
        }
      },

      // Render Methods (real data, with dates)
      renderAll: async () => {
        App.showSpinner(null, true);
        try {
          const [news, approvedReports, transactions, welfare, polls, loans, notifications] = await Promise.all([
            App.fetchWithAuth('/news'),
            App.fetchWithAuth('/approved-reports'),
            App.fetchWithAuth(`/transactions?member=${encodeURIComponent(App.data.user)}`),
            App.fetchWithAuth(`/welfare?member=${encodeURIComponent(App.data.user)}`),
            App.fetchWithAuth('/polls'),
            App.fetchWithAuth(`/loans?member=${encodeURIComponent(App.data.user)}`),
            App.fetchWithAuth(`/notifications?member=${encodeURIComponent(App.data.user)}`)
          ]);
          App.data.news = news;
          App.data.approvedReports = approvedReports;
          App.data.transactions = transactions;
          App.data.welfare = welfare;
          App.data.polls = polls;
          App.data.loans = loans;
          App.data.notifications = notifications;

          App.renderNews();
          App.renderApprovedReports();
          App.renderFinance();
          App.renderWelfareMember();
          App.renderPolls();
          // Dashboard stats with formatting
          document.getElementById('dash-poll-count').innerText = polls.filter(p => p.active).length;
          document.getElementById('dash-welfare-status').innerText = welfare.length > 0 ? `${welfare.length} Pending Claim${welfare.length > 1 ? 's' : ''}` : 'Good Standing';
          const liquidity = transactions.reduce((sum, t) => sum + (t.type === 'in' ? parseInt(t.a || 0) : -parseInt(t.a || 0)), 0);
          document.getElementById('dash-liquidity').innerText = `KES ${liquidity.toLocaleString()}`;

          // Profile data
          const members = await App.fetchWithAuth('/members');
          const member = members.find(m => m.name === App.data.user);
          if (member) {
            document.getElementById('profile-name').value = member.name;
            document.getElementById('profile-email').value = member.email;
          }
        } catch (err) {
          App.toast('Failed to load data (check connection)', 'error');
          console.error(err);
        } finally {
          App.showSpinner(null, false);
        }
      },

      renderNews: () => {
        const feed = document.getElementById('member-news-feed');
        feed.innerHTML = App.data.news.map(n => `<p class="text-sm text-slate-300">${n.text} <span class="text-xs text-slate-500">- ${n.signedBy} on ${new Date(n.createdAt).toLocaleDateString()}</span></p>`).join('') || '<p class="text-slate-500 italic">No announcements yet.</p>'; // Enhancement: Date format
      },

      renderApprovedReports: () => {
        const reports = document.getElementById('approved-reports');
        reports.innerHTML = App.data.approvedReports.map(r => `<p class="text-sm text-slate-300">${r.text} <span class="text-xs text-slate-500">- ${r.signedBy} ${r.file ? `(File: ${r.file})` : ''}</span></p>`).join('') || '<p class="text-slate-500 italic">No reports yet.</p>';
      },

      renderFinance: () => {
        const list = document.getElementById('finance-list');
        list.innerHTML = App.data.transactions.map(t => `<div class="p-4 ${t.type === 'in' ? 'text-green-400' : 'text-red-400'}"><strong>${t.t}</strong> - ${t.d} | KES ${parseInt(t.a).toLocaleString()}</div>`).join('') || '<div class="p-4 text-slate-500 italic">No transactions yet.</div>';
      },

      renderWelfareMember: () => {
        const list = document.getElementById('welfare-list');
        list.innerHTML = App.data.welfare.map(w => `<div class="p-3 bg-white/5 rounded-lg"><strong>${w.type}</strong>: KES ${w.amount.toLocaleString()} (${w.status}) - ${w.date}</div>`).join('') || '<div class="p-3 text-slate-500 italic">No welfare claims yet.</div>';
      },

      renderPolls: () => {
        const container = document.getElementById('polls-container');
        container.innerHTML = App.data.polls.map(p => `
          <div class="glass p-4 rounded-xl">
            <h4 class="font-bold text-white mb-2">${p.q}</h4>
            ${p.opts.map((opt, i) => `<button onclick="App.vote(${p.id}, ${i})" class="block w-full text-left p-2 hover:bg-white/10 rounded ${p.voters.includes(App.data.user) ? 'opacity-50 cursor-not-allowed' : ''}" ${p.voters.includes(App.data.user) ? 'disabled' : ''} aria-label="Vote for ${opt}">${opt} (${p.votes[i]} votes)</button>`).join('')}
            ${!p.active ? '<p class="text-xs text-slate-500 mt-2">Poll closed.</p>' : ''}
          </div>
        `).join('') || '<p class="text-slate-500 italic">No polls yet.</p>';
        document.getElementById('download-btn')?.classList.toggle('hidden', App.data.polls.length === 0);
      },

      vote: async (pollId, optionIdx) => {
        const poll = App.data.polls.find(p => p.id === pollId);
        if (!poll || !poll.active || poll.voters.includes(App.data.user)) return App.toast('Cannot vote', 'error');
        try {
          // Note: Full backend vote update needed; here simulate for demo
          poll.votes[optionIdx]++;
          poll.voters.push(App.data.user);
          App.renderPolls();
          App.toast('Vote cast successfully', 'success');
        } catch (err) {
          App.toast('Vote failed', 'error');
        }
      },

      renderNotifications: () => {
        const list = document.getElementById('notif-list');
        const badge = document.getElementById('notif-badge');
        const unread = App.data.notifications.filter(n => !n.read).length;
        badge.innerText = unread;
        badge.classList.toggle('hidden', unread === 0);
        list.innerHTML = App.data.notifications.map(n => `<div class="p-2 ${n.read ? 'opacity-50' : ''} hover:bg-white/10 rounded cursor-pointer" onclick="App.markRead(${n.id})" role="button" tabindex="0" aria-label="Notification: ${n.msg}">${n.msg}</div>`).join('') || '<p class="text-slate-500 italic">No notifications yet.</p>';
      },

      markRead: async (id) => {
        try {
          await App.fetchWithAuth(`/notifications/${id}/read`, { method: 'PATCH' });
          App.data.notifications[id].read = true;
          App.renderNotifications();
        } catch (err) {
          App.toast('Mark read failed', 'error');
        }
      },

      toggleNotifications: () => {
        const panel = document.getElementById('notifications-panel');
        panel.classList.toggle('hidden');
      },

      // Modals & Submits
      openWelfareModal: () => document.getElementById('modal-welfare').classList.remove('hidden'),

      openLoanModal: () => document.getElementById('modal-loan').classList.remove('hidden'),

      submitWelfare: async () => {
        const type = document.getElementById('welfare-type').value;
        const amount = parseInt(document.getElementById('welfare-amount').value);
        if (!type || isNaN(amount) || amount <= 0) return App.toast('Valid type and positive amount required', 'error');
        App.showSpinner('welfare-spinner');
        try {
          await App.fetchWithAuth('/welfare', { method: 'POST', body: JSON.stringify({ type, amount, member: App.data.user }) });
          App.toast('Claim submitted successfully', 'success');
          document.getElementById('modal-welfare').classList.add('hidden');
          document.getElementById('welfare-type').value = 'Medical Emergency';
          document.getElementById('welfare-amount').value = '';
          await App.renderAll();
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('welfare-spinner', false);
        }
      },

      submitLoan: async () => {
        const amount = parseInt(document.getElementById('loan-amount').value);
        const purpose = document.getElementById('loan-purpose').value.trim();
        if (isNaN(amount) || amount <= 0 || !purpose || purpose.length < 10) return App.toast('Positive amount and purpose (10+ chars) required', 'error');
        App.showSpinner('loan-spinner');
        try {
          await App.fetchWithAuth('/loans', { method: 'POST', body: JSON.stringify({ amount, purpose, member: App.data.user }) });
          App.toast('Loan applied successfully', 'success');
          document.getElementById('modal-loan').classList.add('hidden');
          document.getElementById('loan-amount').value = '';
          document.getElementById('loan-purpose').value = '';
          await App.renderAll();
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('loan-spinner', false);
        }
      },

      uploadSlip: () => App.toast('Upload feature coming soon', 'info'),

      downloadResults: () => App.toast('Download feature coming soon', 'info'),

      // Admin Methods
      adminLogin: (role) => {
        document.getElementById('admin-screen-login').classList.add('hidden');
        document.getElementById(`view-admin-${role}`).classList.remove('hidden');
        const badge = document.getElementById('admin-badge');
        badge.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        badge.className = 'text-[10px] bg-white/10 px-2 py-0.5 rounded text-green-400 ml-2 uppercase';
      },

      adminLogout: () => {
        document.getElementById('portal-admin').classList.add('hidden', 'opacity-0', 'scale-95');
        document.getElementById('portal-member').classList.remove('hidden');
        document.getElementById('admin-screen-login').classList.remove('hidden');
        document.querySelectorAll('[id^="view-admin-"]').forEach(el => el.classList.add('hidden'));
      },

      createPoll: async () => {
        const question = document.getElementById('poll-question').value.trim();
        const optsStr = document.getElementById('poll-opts').value.trim();
        if (!question || !optsStr) return App.toast('Question and options required', 'error');
        const options = optsStr.split(',').map(o => o.trim()).filter(Boolean);
        if (options.length < 2) return App.toast('At least 2 options required', 'error');
        App.showSpinner('poll-spinner');
        try {
          await App.fetchWithAuth('/polls', { method: 'POST', body: JSON.stringify({ question, options }) });
          App.toast('Poll created successfully', 'success');
          document.getElementById('poll-question').value = '';
          document.getElementById('poll-opts').value = '';
          await App.renderAll();
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('poll-spinner', false);
        }
      },

      closePoll: () => App.toast('Close poll: Select and update backend', 'info'),

      promoteMember: async () => {
        const email = document.getElementById('promote-email').value.trim();
        const role = document.getElementById('promote-role').value;
        if (!email || !role || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return App.toast('Valid email and role required', 'error');
        App.showSpinner('promote-spinner');
        try {
          await App.fetchWithAuth(`/members/${email}/promote`, { method: 'POST', body: JSON.stringify({ role }) });
          App.toast('Member promoted successfully', 'success');
          document.getElementById('promote-email').value = '';
          document.getElementById('promote-role').value = '';
        } catch (err) {
          App.toast(err.message, 'error');
        } finally {
          App.showSpinner('promote-spinner', false);
        }
      },

      // Placeholder for other admin actions (extend with fetchWithAuth + spinners)
      executeHandover: (role) => App.toast(`Handover for ${role}: Implement signature update`, 'info'),
      addCommitteeNote: (type) => App.toast(`Note for ${type}: Add to chair queue`, 'info'),
      downloadAuditReport: () => App.toast('Audit report download: Generate PDF', 'info'),
      submitNews: () => App.toast('News draft: Submit to chair queue', 'info'),

      // PIN modal (original, unchanged)
      verifyPin: () => App.toast('PIN verification: Extend for admin unlock', 'info')
    };

    // PWA SW
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => console.log('SW registration failed'));
    }

    window.onload = () => {
      setTimeout(() => document.getElementById('splash-screen').classList.add('opacity-0', 'pointer-events-none'), 1500);
      setTimeout(() => document.getElementById('splash-screen').classList.add('hidden'), 2200);
    };
  </script>
</body>
</html>
